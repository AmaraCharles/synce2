"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[89052],{242337:(e,t,s)=>{s.d(t,{StudyBaseWindowView:()=>n});var i=s(49839),r=s(287741);class n extends i.DataWindowView{constructor(e,t){super(),this._invalidated=!0,this._study=e,this._model=t,this._valueProvider=this._createValuesProvider(e,t),this._items=this._valueProvider.getItems().map((e=>new i.DataWindowItem(e.id,e.title,""))),this.update()}update(){this._invalidated=!0}items(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._items}study(){return this._study}_updateImpl(){this._header=this._study.title(r.TitleDisplayTarget.DataWindow,!0),this._title=this._study.title(r.TitleDisplayTarget.DataWindow);const e=this._valueProvider.getValues(this._currentIndex());for(let t=0;t<e.length;++t){const s=e[t],i=this._items[t];i.setValue(s.value),i.setVisible(s.visible),i.setColor(s.color),i.setTitle(s.title)}}_currentIndex(){const e=this._model.crossHairSource().appliedIndex();return isNaN(e)?null:e}}},193938:(e,t,s)=>{s.d(t,{StudyDataWindowView:()=>n});var i=s(242337),r=s(316980);class n extends i.StudyBaseWindowView{canShowItems(){const e=this._model.paneForSource(this._study);return!!e?.maximized().value()||this._model.panes().every((e=>!e.maximized().value()))}_createValuesProvider(e,t){return new r.StudyDataWindowValuesProvider(e,t)}}},181945:(e,t,s)=>{s.d(t,{StudyStatusProvider:()=>l});var i=s(444372),r=s(757402),n=s(971417),o=s(170411);const a=i.t(null,void 0,s(224077));class l extends o.StudyStatusProviderBase{sourceStatusText(){const e=this._source;if(e.status().type===r.StudyStatusType.Error){const t=e.metaInfo(),s=(0,n.extractPineId)(t.fullId);if(t.scriptIdPart&&(0,n.isEdgrPineId)(t.scriptIdPart)||s&&(0,n.isEdgrPineId)(s))return a}return super.sourceStatusText()}}},689052:(e,t,s)=>{s.r(t),s.d(t,{Study:()=>us});var i=s(650279),r=s(154834),n=s(998034),o=s(650151),a=s(444372),l=s(338619),h=s(879938),c=s(716004),u=s(682170),d=s(799878),p=s(19303),_=s(218049),f=s(230839);function m(e){const t=new Set;e.metaInfo().historyCalculationMayChange&&t.add(p.DataSourceDangerReason.PineRepainting);for(const s of Object.values(e.inputs()))if((0,_.isExtendedInput)(s)&&"symbol"===s.t){const i=e.resolvedSymbolInfoBySymbol(s.v);"spread"===i?.type&&t.add(p.DataSourceDangerReason.Spread),"CRYPTOCAP"===i?.exchange&&t.add(p.DataSourceDangerReason.CryptoCap)}for(const s of e.parentSources())(0,f.addToSet)(t,m(s));const s=e.ownerSource();return e.isChildStudy()&&s&&(0,f.addToSet)(t,m(s)),t}function y(e){const[t]=m(e);return t??null}var g=s(924166),S=s(923451),b=s(590508),v=s(640146),I=s(545437),P=s(120984),w=s(942634),C=s(432059),V=s(355468),x=s(979351),A=s(475892),R=s(704670),M=s(55243),D=s(637761),T=s(656723),O=s(518439),N=s(497503),F=s(242337),k=s(843563),B=s(748947);class E extends F.StudyBaseWindowView{constructor(e,t){super(e,t),this._showStudyValues=t.properties().childs().paneProperties.childs().legendProperties.childs().showStudyValues,this._showStudyValues.subscribe(this,this.update);const s=this._study.properties()
;s.childs().showLegendValues.subscribe(this,this.update);const i=this._study.metaInfo().plots,r=new Set;i.forEach((e=>{if((0,B.isOhlcPlot)(e)){const t=e.target;if(r.has(t))return;r.add(t),s.childs().ohlcPlots.childs()[t].childs().display.subscribe(this,this.update)}else(0,B.isPlotSupportDisplay)(e)&&s.childs().styles.childs()[e.id]?.childs().display.subscribe(this,this.update)}))}areValuesVisible(){return this._showStudyValues.value()}additional(){return null}destroy(){this._showStudyValues.unsubscribeAll(this);const e=this._study.properties();e.childs().showLegendValues.unsubscribeAll(this);const t=this._study.metaInfo().plots,s=new Set;t.forEach((t=>{if((0,B.isOhlcPlot)(t)){const i=t.target;if(s.has(i))return;s.add(i),e.childs().ohlcPlots.childs()[i].childs().display.unsubscribe(this,this.update)}else(0,B.isPlotSupportDisplay)(t)&&e.childs().styles.childs()[t.id]?.childs().display.unsubscribe(this,this.update)}))}_createValuesProvider(e,t){return new k.StudyLegendValuesProvider(e,t)}}var L=s(419283),H=s(323719),U=s(882782),z=s(362805),G=s(124066),j=s(181945),W=s(124829),$=s(287741),K=s(828473),q=s(401809);class Y{constructor(e,t,s=!1){this.price=t,this.index=e,this.useMainSeriesForPriceRange=s}}var J=s(597461);function Z(e,t,s,i){if(e.y1===e.y2)return function(e,t,s){return(0,o.assert)(e.y1===e.y2),(0,J.doesItemAffectVisibleRange)(e.x1,e.x2,e.extend,t,s)?[new Y(t,e.y1,!1),new Y(s,e.y2,!1)]:[]}(e,s,i);const r=[];return null!==e.x1&&r.push(new Y(e.x1,e.y1,!1)),null!==e.x2&&r.push(new Y(e.x2,e.y2,!1)),r}function X(e,t,s,i){return e.points.filter((e=>e.x>=s&&e.x<=i)).map((e=>new Y(e.x,e.y,!1)))}function Q(e,t,s,i){return(0,J.doesItemAffectVisibleRange)(e.left,e.right,e.extend,s,i)?[new Y(s,e.top,!1),new Y(i,e.bottom,!1)]:[]}var ee=s(15141);function te(e,t,s,i){let r;const n=e.yloc!==ee.DwgLabelYloc.Price&&e.yloc!==ee.DwgLabelYloc.Auto;if(n){const s=e.yloc===ee.DwgLabelYloc.AboveBar?2:3,i=t.valueAt(e.x);null!==i&&(r=i[s])}else r=e.y;return null==r?null:[new Y(e.x,r,n)]}function se(e,t,s,i,r,n){if(!(0,J.doesItemAffectVisibleRange)(e.firstBarTime,e.lastBarTime,J.DwgExtend.None,s,i))return[];let o=1/0,a=-1/0;for(const[t,s]of r.tpoBlockSets())if(n===t)for(const t of s.get(e.id)||[])o=Math.min(o,t.rowIndex*e.priceRange),a=Math.max(a,(t.rowIndex+1)*e.priceRange);return Number.isFinite(o)?[new Y(s,a,!1),new Y(i,o,!1)]:[]}class ie{constructor(e,t,s,i,r){this._mapGetter=e,this._study=t,this._bars=t.series().bars(),this._visibilityGetter=s,this._getPoints=i,this._getMargins=r}groupPriceRange(e,t,s){let i=null;const r=this._study.graphics();for(const[n,o]of this._mapGetter(s))if(this._visibilityGetter(n))for(const s of o){const o=this._getPoints(s,this._bars,e,t,r,n);if(null===o)continue;let a=1/0,l=-1/0,h=!1,c=!1,u=!1;for(const s of o){const i=s.index<=t,r=s.index>=e;h=h||i,c=c||r,u=u||i&&r;let n=s.price,o=s.price;if(s.useMainSeriesForPriceRange){const e=this._bars.valueAt(s.index);if(null===e)continue;const t=e[2];if(null==t)continue;const i=e[3];if(null==i)continue;n=i,o=t}n<a&&(a=n),o>l&&(l=o)}if(!(u||h&&c))continue
;const d=new R.PriceRange(a,l);i=null===i?d:i.merge(d)}return i}firstValue(e,t){let s=1/0,i=1/0,r=-1/0,n=1/0,o=1/0,a=1/0;const l=this._study.graphics();for(const[h,c]of this._mapGetter(!1))if(this._visibilityGetter(h))for(const u of c){const c=this._getPoints(u,this._bars,e,t,l,h);if(null!==c)for(const l of c){const h=l.index;h>=e&&h<=t&&h<s?(s=h,i=l.price):h<e&&h>r?(r=h,n=l.price):h>t&&h<o&&(o=h,a=l.price)}}return{firstVisible:s===1/0?null:new Y(s,i),leftClosest:r===-1/0?null:new Y(r,n),rightClosest:o===1/0?null:new Y(o,a)}}groupPixelMargins(e,t,s){if(!this._getMargins)return re();const i=re();if(null===this._study.priceScale())return i;if(null===this._study.firstValue())return i;const r=this._study.graphics();for(const[n,o]of this._mapGetter(s))if(this._visibilityGetter(n))for(const s of o){const o=this._getPoints(s,this._bars,e,t,r,n);if(null===o)continue;if(0===o.filter((s=>{const i=s.index;return i>=e&&i<=t})).length)continue;const a=this._getMargins(s,this._bars);i.bottomPixelMargin=Math.max(i.bottomPixelMargin,a.bottomPixelMargin),i.topPixelMargin=Math.max(i.topPixelMargin,a.topPixelMargin)}return i}}const re=()=>({bottomPixelMargin:0,topPixelMargin:0});function ne(e){const t=(0,o.ensureDefined)(e.properties().childs().graphics).childs();return[new ie((()=>(0,K.mapEntriesGenerator)(e.graphics().tpos())),e,(e=>{const s=(0,o.ensureDefined)(t.tpoBlockSets).childs()[e].childs();return s.showLetters.value()||s.showBlocks.value()||(0,o.ensureDefined)(t.tpoVolumeRows).childs()[e].childs().visible.value()}),se,re),new ie((t=>(0,K.nestedMapGenerator)(e.graphics().dwglabels(),t)),e,(e=>(0,o.ensureDefined)(t.dwglabels).childs()[e].childs().visible.value()),te,q.calculateDwgLabelsMargins.bind(null,e)),new ie((t=>(0,K.nestedMapGenerator)(e.graphics().dwglines(),t)),e,(e=>(0,o.ensureDefined)(t.dwglines).childs()[e].childs().visible.value()),Z,re),new ie((t=>(0,K.nestedMapGenerator)(e.graphics().dwgpolylines(),t)),e,(e=>(0,o.ensureDefined)(t.dwgpolylines).childs()[e].childs().visible.value()),X,re),new ie((t=>(0,K.nestedMapGenerator)(e.graphics().dwgboxes(),t)),e,(e=>(0,o.ensureDefined)(t.dwgboxes).childs()[e].childs().visible.value()),Q,re),new ie((t=>function*(e,t){const s=e.dwglines(),i=e.dwglinefills(),r=new Map;s.forEach((e=>{if(void 0===t)e.forEach((e=>{e?.forEach((e=>{r.set(e.id,e)}))}));else{const s=e.get(t);s?.forEach((e=>{r.set(e.id,e)}))}}));for(const[e,t]of i){const s=Array.from(t).filter((e=>r.has(e.line1)));s.length&&(yield[e,new Set(s)])}}(e.graphics(),t)),e,(e=>(0,o.ensureDefined)(t.dwglinefills).childs()[e].childs().visible.value()),((t,s,i,r)=>{const n=new Map;for(const[,t]of e.graphics().dwglines())for(const[,e]of t)for(const t of e)n.set(t.id,t);return function(e,t,s,i,r){const n=e.get(t.line1),o=e.get(t.line2);return void 0!==n&&void 0!==o&&((0,J.doesItemAffectVisibleRange)(n.x1,n.x2,n.extend,i,r)||(0,J.doesItemAffectVisibleRange)(o.x1,o.x2,o.extend,i,r))?[new Y(i,n.y1,!1),new Y(r,n.y2,!1),new Y(i,o.y1,!1),new Y(r,o.y2,!1)]:[]}(n,t,0,i,r)}),re)]}function oe(e,t,s){
return null===t?e:null===e?t:e.index<t.index?s?t:e:s?e:t}class ae{constructor(){this.firstVisible=null,this.leftClosest=null,this.rightClosest=null}improve(e){this.firstVisible=oe(this.firstVisible,e.firstVisible,!0),this.leftClosest=oe(this.leftClosest,e.leftClosest,!0),this.rightClosest=oe(this.rightClosest,e.rightClosest,!1)}bestPrice(){return null!==this.firstVisible?this.firstVisible.price:null!==this.leftClosest?this.leftClosest.price:null!==this.rightClosest?this.rightClosest.price:null}}var le=s(175203),he=s(971417),ce=s(296842),ue=s(354957),de=s(322825),pe=s(78007);function _e(e,t){return e.studyId.localeCompare(t.studyId)}function fe(e){const t=new Set,s=[];return e.forEach((e=>{t.has(e.studyId)||(t.add(e.studyId),s.push(e))})),s}function me(e){const t=e.model().mainSeries();return{studyId:(0,o.ensureNotNull)(e.sourceId()),turnaround:e.turnaround(),sourceStudies:e.parentSources().filter((e=>e!==t)).map((e=>me(e)))}}var ye=s(764829),ge=s(982949),Se=s(961970);class be extends Se.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=e}hitTest(e){return null}_drawImpl(e){}_drawBackgroundImpl(e){const{context:t,horizontalPixelRatio:s,bitmapSize:i}=e,r=this._data;for(let e=0;e<r.items.length;++e){const n=r.items[e];if(null==n.color)continue;t.fillStyle=n.color;const o=Math.round(n.left*s)+1,a=Math.round(n.right*s);t.fillRect(o,0,a-o+1,i.height)}}}var ve=s(962973),Ie=s(249121);class Pe extends Ie.StudyForceOverlayPlotView{constructor(e,t,s,i){super(t,s,i),this._items=[],this._invalidated=!0,this._isMarkersEnabled=ye.enabled("source_selection_markers"),this._study=e;const r=this._study.metaInfo().plots;for(let e=0;e<r.length;e++){const t=r[e];t.id===this._plotName&&(this._plotIndex=e,(0,o.assert)((0,B.isBgColorerPlot)(t),"Plot '"+this._plotName+"' is not a background colorer!"))}this._colorProvider=(0,ve.createStudyPlotColorProvider)(e.metaInfo(),e.properties(),i)}items(){return this._items}update(){this._invalidated=!0}renderer(){if(1&~(0,o.ensureDefined)(this._study.properties().childs().styles.childs()[this._plotName]).childs().display.value())return null;if(!this._scalesReady())return null;this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={items:this._items},t=new ge.CompositeRenderer;return t.append(new be(e)),t}_scalesReady(){const e=this._model.timeScale(),t=this._priceScale();return e&&!e.isEmpty()&&null!==t&&!t.isEmpty()}_getTranspValue(){const e=(0,o.ensureDefined)(this._study.properties().childs().styles.childs()[this._plotName]).childs();let t=0;return e.transparency&&(t=e.transparency.value(),t=(0,W.isNumber)(t)?t:40),t}_updateImpl(){this._items=[],(0,o.assert)(this._scalesReady(),"Scales must be ready!");const e=this._model.timeScale().visibleBarsStrictRange();if(null===e)return;const t=this._getTranspValue();let s=(0,o.ensureDefined)(this._series.nearestIndex(e.firstBar(),O.PlotRowSearchMode.NearestRight)),i=(0,o.ensureDefined)(this._series.nearestIndex(e.lastBar(),O.PlotRowSearchMode.NearestLeft));const r=this._study.offset(this._plotName);r>0?(s-=r,i+=r):(s+=r,i-=r)
;const n=this._study.getMinFirstBarIndexForPlot(this._plotName);if(n>i)return;s=Math.max(n,s);const a=this._study.data();for(const e of a.rangeIterator(s,i)){let s=e.index;const i=e.value;s+=r;const n={timePointIndex:Math.floor(s),left:NaN,center:NaN,right:NaN};let a=(0,W.isNumber)(t)?t:50;a=Math.min(a,100),a=Math.max(a,0);const l=this._colorProvider.getPlotPointStyle(i);void 0!==l.colors[1]&&(n.color=(0,C.generateColor)((0,o.ensureDefined)(l.colors[1]),a)),this._items.push(n)}this._model.timeScale().fillBarBorders(this._items)}}var we=s(112377),Ce=s(359658),Ve=s(750139),xe=s(836687),Ae=s(368628),Re=s(40563),Me=s(354012),De=s(381065),Te=s(744688),Oe=s(743537),Ne=s(754533),Fe=s(819788),ke=s(311156),Be=s(975696),Ee=s(245356),Le=s(337827);const He=new Map;He.set("PaneRendererArrowUp",Me.PaneRendererArrowUp),He.set("PaneRendererArrowDown",Me.PaneRendererArrowDown),He.set("PaneRendererCircleShape",De.PaneRendererCircleShape),He.set("PaneRendererCrossShape",Te.PaneRendererCrossShape),He.set("PaneRendererDiamond",Oe.PaneRendererDiamond),He.set("PaneRendererFlagShape",Ne.PaneRendererFlagShape),He.set("PaneRendererLabelUp",Fe.PaneRendererLabelUp),He.set("PaneRendererLabelDown",Fe.PaneRendererLabelDown),He.set("PaneRendererSquare",ke.PaneRendererSquare),He.set("PaneRendererTriangleApexUp",Be.PaneRendererTriangleApexUp),He.set("PaneRendererTriangleApexDown",Be.PaneRendererTriangleApexDown),He.set("PaneRendererXCross",Ee.PaneRendererXCross);class Ue extends Le.StudyPaneViewInplaceUpdatable{constructor(e,t,s,i){super(t,s,i),this._renderer=null,this._shapesRenderer=null,this._selectionRenderer=null,this._isMarkersEnabled=ye.enabled("source_selection_markers"),this._study=e;const r=e.metaInfo().plots;for(let e=0;e<r.length;e++)if(r[e].id===this._plotName){this._plotIndex=e;break}this._plotStyleInfo=(0,o.ensureDefined)(e.metaInfo().styles?.[this._plotName]),this._colorProvider=(0,ve.createStudyPlotColorProvider)(e.metaInfo(),e.properties(),i),this._selectionIndexer=new xe.SelectionIndexes(s.timeScale())}items(){return this._items}renderer(){return this._isPlotVisible()&&this._scalesReady()?(this._makeSureRendererIsValid(),this._renderer):null}_isPlotVisible(){return this._study.isPlotVisibleAt(this._plotName,1)}_scalesReady(){const e=this._model.timeScale(),t=this._priceScale();return e&&null!==t&&!e.isEmpty()&&!t.isEmpty()}_updateImplFull(e){if(this._dataInvalidated?.clearData&&(this._items=[],this._renderer=null),!this._scalesReady())return!1;const t=this._model.timeScale(),s=this._priceScale(),i=t.visibleBarsStrictRange();if(null===i||null===s)return!1;const r=this._study.plots().plottableRange(!1);if(0===r.size())return!1;const n=this._study.offset(this._plotName),a=this._study.firstValue(void 0,this.isForceOverlay());if(null===a)return!1;this._updateAdditionalPrices(s,a);const{hiPlot:l,loPlot:h}=this._hiLoPlots(),c=this._preallocateItems(r,((e,t)=>this._createItem(e,t??null,l,h,n)))
;let u=this._series.nearestIndex(i.firstBar(),O.PlotRowSearchMode.NearestRight),d=this._series.nearestIndex(i.lastBar(),O.PlotRowSearchMode.NearestLeft);if(void 0===u||void 0===d)return!1;n>0?(u-=n,d+=n):(u+=n,d-=n);const p=this._study.getMinFirstBarIndexForPlot(this._plotName);if(p>d)return!0;u=Math.max(p,u);const _=this._getTranspValue(),f=this._study.properties().childs().styles.childs()[this._plotName].childs(),m=f.color.value(),y=f.textColor?f.textColor.value():void 0,g=m,S=m,b=void 0===y?void 0:y,v=(0,o.ensureNotNull)(this._plotIndex),I=(0,Re.createEmptyStyle)(),P=c??(0,o.ensureNotNull)(r.firstIndex()),w=r.rangeIterator(P,(0,o.ensureNotNull)(r.lastIndex())+1);let C=(0,K.lowerbound)(this._items,P+n,((e,t)=>e.timePointIndex<t));for(const e of w){const t=e.value,s=t[v+1];if(null==s){C++;continue}const i=this._items[C];if(!isNaN(i.origPrices.price)){if(this._colorProvider.isColorDefined()){i.style={color:g,borderColor:S,textColor:b};const e=this._colorProvider.getPlotPointStyle(t,I);this._fillItemWithPointStyle(i,e,_)}}C++}return this._updateImplLight(),!0}_fillItemWithPointStyle(e,t,s){const i=(0,o.ensureDefined)(e.style);if(void 0!==t.colors[0]){i.color=(0,C.generateColor)((0,o.ensureDefined)(t.colors[0]),s);const e=s>9?s-10:0;i.borderColor=(0,C.generateColor)(i.color,e)}void 0!==t.colors[2]&&(i.textColor=(0,C.generateColor)((0,o.ensureDefined)(t.colors[2]),s))}_updateRenderer(e,t){this._makeSureRendererIsValid();const s=this._model.timeScale(),i={},r=this._getTranspValue(),n=s.barSpacing(),o=this._calculateShapeHeight(n),a=this._study.properties().childs().styles.childs()[this._plotName].childs(),l=a.location.value(),h=this._calculateVerticalOffset(l,o+o/2);i.barSpacing=n,i.items=this._items,i.color=(0,C.generateColor)(a.color.value(),r),i.height=o,i.vertOffset=h,i.visibleItemsRange={startItemIndex:e,endItemIndex:t};const c=a.plottype.value(),u=Ce.plotShapesData[c],d=new ge.CompositeRenderer;u&&(this._shapesRenderer?this._shapesRenderer.setData(i):(this._shapesRenderer=this._createRenderer(u.paneRendererClass,i),d.append(this._shapesRenderer))),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData&&(this._selectionData.vertOffset=h,d.append(new we.SelectionRenderer(this._selectionData))),this._renderer=d}_createRenderer(e,t){const s=He.get(e);return new((0,o.ensureDefined)(s))(t)}_getSeriesVal(e,t){const s=(0,Ae.barFunction)(e),i=this._series.data().valueAt(t);return null===i?null:s(i)}_getTranspValue(){let e=0;const t=this._study.properties().childs();t.transparency&&(e=t.transparency.value(),e=(0,W.isNumber)(e)?e:50);const s=t.styles.childs()[this._plotName].childs();return s.transparency&&(e=s.transparency.value(),e=(0,W.isNumber)(e)?e:50),(0,Ve.clamp)(e,0,100)}_createItem(e,t,s,i,r){const n=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value(),a={origPrices:{price:NaN},timePointIndex:e+r};if((null===t||0===t)&&n!==N.MarkLocation.Absolute)return a;if(null==t)return a;let l=NaN;switch(n){case N.MarkLocation.AboveBar:{
const t=this._getLocationPrice(e,s,r);if(null===t)return a;l=t;break}case N.MarkLocation.BelowBar:{const t=this._getLocationPrice(e,i,r);if(null===t)return a;l=t;break}case N.MarkLocation.Absolute:l=(0,o.ensureNotNull)(t);break;case N.MarkLocation.Top:case N.MarkLocation.Bottom:l=0;break;default:throw new Error("Bad value: "+n)}return{y:NaN,origPrices:{price:l},timePointIndex:e+r}}_dependsOnSeriesData(){const e=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value();return e===N.MarkLocation.AboveBar||e===N.MarkLocation.BelowBar}_getValueForUpdating(e){const t=e.value[this._plotIndex+1];if(null==t)return null;const s=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value();if(0===t&&s!==N.MarkLocation.Absolute)return null;const i=this._study.offset(this._plotName),{hiPlot:r,loPlot:n}=this._hiLoPlots();switch(s){case N.MarkLocation.AboveBar:return this._getLocationPrice(e.index,r,i);case N.MarkLocation.BelowBar:return this._getLocationPrice(e.index,n,i)}return super._getValueForUpdating(e)}_convertItemsToCoordinates(e,t,s,i){for(let e=s;e<i;e++){const t=this._items[e];t.y=t.origPrices.price}this._model.timeScale().fillBarBorders(this._items);const r=this._study.properties().childs().styles.childs()[this._plotName].childs().location.value(),n=e.height()*e.topMargin(),o=e.height()*(1-e.bottomMargin()),a=e.isInverted(),l=a?o:n,h=a?n:o,c=e=>{for(let t=s;t<i;t++)isNaN(this._items[t].y)||(this._items[t].y=e)};switch(r){case N.MarkLocation.Top:c(l);break;case N.MarkLocation.Bottom:c(h);break;default:e.pointsArrayToCoordinates(this._items,t,{startItemIndex:s,endItemIndex:i})}}_calculateVerticalOffset(e,t){let s=0;switch(e){case N.MarkLocation.AboveBar:case N.MarkLocation.Bottom:s=-t;break;case N.MarkLocation.BelowBar:case N.MarkLocation.Top:s=t}return(0,o.ensureNotNull)(this._priceScale()).isInverted()&&(s*=-1),s}_calculateShapeHeight(e,t){let s=e;switch(t){case B.PlotSymbolSize.Tiny:s=.3*e;break;case B.PlotSymbolSize.Small:s=.6*e;break;case B.PlotSymbolSize.Normal:s=e;break;case B.PlotSymbolSize.Large:s=1.5*e;break;case B.PlotSymbolSize.Huge:s=2*e}return"number"==typeof t&&t>0&&(s=t),s}_hiLoPlots(){let e,t;let s=null;switch(this._series.properties().childs().style.value()){case 2:s="lineStyle";break;case 14:s="lineWithMarkersStyle";break;case 15:s="steplineStyle";break;case 3:s="areaStyle"}return s?(e=this._series.properties().childs()[s].childs().priceSource.value(),t=e):(e="high",t="low"),{hiPlot:e,loPlot:t}}_getLocationPrice(e,t,s){const i=Math.min(e+s,(0,o.ensureNotNull)(this._series.data().last()).index);return this._getSeriesVal(t,i)}}class ze extends Ue{_updateRenderer(e,t){const s=this._study.properties().childs().styles.childs()[this._plotName].childs(),i=this._model.timeScale(),r={},n=this._getTranspValue(),o=i.barSpacing();let a;a=this._plotStyleInfo.size?this._calculateShapeHeight(25,this._plotStyleInfo.size):Math.round(o/2),a=Math.max(a,1);const l=s.location.value(),h=(0,
C.generateColor)(s.color.value(),n),u=n>19?n-10:0,d=this._calculateVerticalOffset(l,Math.round(1.5*a));r.barSpacing=o,r.items=this.items(),r.color=h,r.borderColor=(0,C.generateColor)(s.color.value(),u),r.height=a,r.vertOffset=d,r.visibleItemsRange={startItemIndex:e,endItemIndex:t};const p=s.plottype.value(),_=Ce.plotShapesData[p],f=this._plotStyleInfo.text;if(void 0!==f&&""!==f.trim()){let e=f.trim().replace(/\\n/gm,"\n");e=(0,c.cleanButAmpersand)(e,!0),r.text=e,r.fontSize=12;const t=s.textColor?s.textColor.value():void 0;r.textColor=t?(0,C.generateColor)(t,n):h}if(this._renderer&&this._shapesRenderer&&this._selectionRenderer)this._shapesRenderer.setData(r),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData?(this._selectionData.vertOffset=d,this._selectionRenderer.setData(this._selectionData)):this._selectionRenderer.setData(null);else{const e=new ge.CompositeRenderer;this._shapesRenderer=super._createRenderer(_.paneRendererClass,r),e.append(this._shapesRenderer),this._selectionRenderer=new we.SelectionRenderer(this._selectionData??void 0),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData?this._selectionData.vertOffset=d:this._selectionRenderer.setData(null),e.append(this._selectionRenderer),this._renderer=e}}}var Ge=s(687795),je=s.n(Ge),We=s(86441),$e=s(916403),Ke=s(509078),qe=s(286436),Ye=s(511275),Je=s(682995);class Ze extends $e.PaneRendererAbstractShape{constructor(e,t){super(null,t),this._fontSizeEnsured=0,this._ch="",this._fontFamily=Ye.CHART_FONT_FAMILY,this._charCache=null,null!==e&&this.setData(e)}setData(e){super.setData(e),this._fontSizeEnsured=(0,o.ensureDefined)(this._height);const t=e.char.slice(0,40);this._ch=je()(t)[0]||" ",this._fontFamily=e.fontFamily||Ye.CHART_FONT_FAMILY}hitTest(e){const t=(0,qe.interactionTolerance)().series+this._fontSizeEnsured/2;for(const s of this._items){if(new We.Point(s.center,s.y+s.vertOffset).subtract(e).length()<=t)return new Ke.HitTestResult(Ke.HitTarget.Regular)}return null}_drawItemShape(e,t){const s=t.center,i=t.vertOffset>0?1:-1,r=t.y+t.vertOffset-i*Math.round(this._fontSizeEnsured/2);let n;n=t.style&&void 0!==t.style.color?t.style.color:this._color;const o=this._textImageCache(),{context:a,horizontalPixelRatio:l,verticalPixelRatio:h}=e;if(this._fontSizeEnsured<=4/l){a.save();const e=Math.max(1,Math.floor(l));let i=Math.max(1,Math.floor(o.textImageWidth*l));i%2!=e%2&&(i+=i>1?-1:1);const c=Math.round(r*h)+(t.vertOffset>=0?0:-i);return a.fillStyle=n,a.fillRect(Math.round(s*l)+(l%2?.5:0)-i/2,c,i,i),void a.restore()}const c={style:{fillStyle:n},location:{x:s,y:r,horzAlign:Je.HorizontalAlign.Center,vertAlign:t.vertOffset>0?Je.VerticalAlign.Top:Je.VerticalAlign.Bottom}};o.paintTo(e,c)}_startPath(e,t,s){}_endPath(e){}_textImageCache(){return null!==this._charCache&&this._charCache.fontFamily===this._fontFamily&&this._charCache.fontSize===this._fontSizeEnsured||(this._charCache={fontSize:this._fontSizeEnsured,fontFamily:this._fontFamily,
cache:new Je.TextImageCache(this._ch,!1,!1,this._fontFamily,this._fontSizeEnsured,"center",0)}),this._charCache.cache}}class Xe extends Ue{constructor(){super(...arguments),this._charRenderer=new Ze(null)}_updateRenderer(e,t){const s=this._getTranspValue(),i=this._model.timeScale().barSpacing();let r;const n=this._study.properties().childs().styles.childs()[this._plotName].childs();r=this._plotStyleInfo.size?this._calculateShapeHeight(50,this._plotStyleInfo.size):Math.round(i);const a=n.location.value(),l=(0,C.generateColor)(n.color.value(),s),h=this._calculateVerticalOffset(a,r),u={items:this.items(),barSpacing:i,char:(0,o.ensureDefined)(n.char?.value()??this._plotStyleInfo.char),height:r,vertOffset:h,color:l,visibleItemsRange:{startItemIndex:e,endItemIndex:t}},d=this._plotStyleInfo.text;if(void 0!==d&&""!==d.trim()){let e=d.trim().replace(/\\n/gm,"\n");e=(0,c.cleanButAmpersand)(e,!0),u.text=e,u.fontSize=12;const t=n.textColor?n.textColor.value():void 0;u.textColor=t?(0,C.generateColor)(t,s):l}this._charRenderer.setData(u);const p=new ge.CompositeRenderer;p.append(this._charRenderer),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&null!==this._selectionData&&(this._selectionData.vertOffset=h,p.append(new we.SelectionRenderer(this._selectionData))),this._renderer=p}}var Qe=s(724377);class et{constructor(e,t,s,i,r){this.left=NaN,this.right=NaN,this.height=NaN,this.center=e,this.y=t,this.origHeight=s,this.isUp=i,this.origPrices=r,this.timePointIndex=e,this.style={}}}function tt(e){return Math.round(e/4)}function st(e){return Math.round(e/2)}class it extends Se.BitmapCoordinatesPaneRenderer{constructor(e){super(),this._data=e}hitTest(e){const t=this._data,s=st(t.barSpacing),i=Math.round(s/2),r=Math.round(s),n=tt(t.barSpacing),o=t.visibleItemsRange?.startItemIndex??0,a=t.visibleItemsRange?.endItemIndex??t.items.length;if(o>=a)return null;for(const s of t.items.slice(o,a)){if(!s)continue;if(!Number.isFinite(s.center)||!Number.isFinite(s.y))continue;const t=Math.abs(s.height),o=s.isUp?-1:1,a=t+r,l=s.y-o*n,h=l-o*a,c=s.center-i,u=s.center+i;if(c<e.x&&e.x<u&&(s.isUp?l<e.y&&e.y<h:h<e.y&&e.y<l))return new Ke.HitTestResult(Ke.HitTarget.Regular)}return null}_drawImpl(e){const{horizontalPixelRatio:t,verticalPixelRatio:s,context:i}=e,r=this._data,n=st(r.barSpacing),o=tt(r.barSpacing),a=n<4,l=Math.max(n/2,1),h=(0,Ve.ceiledEven)(n*t),c=h/2,u=Math.round(n*s);i.lineCap="butt",i.lineWidth=Math.max(1,Math.floor(t));const d=i.lineWidth%2?.5:0,p=r.visibleItemsRange?.startItemIndex??0,_=r.visibleItemsRange?.endItemIndex??r.items.length;if(!(p>=_))for(const e of r.items.slice(p,_)){if(!Number.isFinite(e.center)||!Number.isFinite(e.y))continue;const n=e.isUp?-1:1,p=Math.round(Math.abs(e.height)*s),_=Math.round(e.center*t)+d,f=Math.round((e.y-n*o)*s)+d;i.beginPath(),i.translate(_,f);const m=(e.style&&e.style.color)??(e.isUp?r.colorup:r.colordown);a?(i.moveTo(0,0),i.lineTo(-c,-c*n),i.moveTo(0,0),i.lineTo(c,-c*n),i.moveTo(0,0),i.lineTo(0,-p*n),i.moveTo(-c,-p*n),i.lineTo(c,-p*n),i.lineWidth=l,i.strokeStyle=m,
i.stroke()):(i.moveTo(0,0),p<u?(i.lineTo(h,-p*n),i.lineTo(-h,-p*n)):(i.lineTo(h,-u*n),i.lineTo(c,-u*n),i.lineTo(c,-p*n),i.lineTo(-c,-p*n),i.lineTo(-c,-u*n),i.lineTo(-h,-u*n)),i.lineTo(0,0),i.strokeStyle=e.isUp?r.colorBorderUp:r.colorBorderDown,i.stroke(),i.fillStyle=m,i.fill()),i.translate(-_,-f)}}}class rt extends we.SelectionRenderer{_drawMarker(e,t,s,i){const{context:r,horizontalPixelRatio:n,verticalPixelRatio:a}=e,l=(0,o.ensureNotNull)(this._data),h=t.isUp?1:-1;const c=s+h*tt(l.barSpacing)+h*st(l.barSpacing);let u=Math.round(3.5*n*2);u%2!=i%2&&(u+=1);const d=i%2/2,p=Math.round(t.center*n)+d,_=Math.round((t.y+c)*a)+d;r.beginPath(),r.arc(p,_,u/2,0,2*Math.PI,!0),r.closePath(),r.fill(),r.stroke()}}class nt extends Ue{_updateRenderer(e,t){const s=this._study.properties().childs().styles.childs()[this._plotName].childs(),i=(0,Ve.clamp)(this._getTranspValue(),0,100),r=this._model.timeScale().barSpacing(),n=(0,C.generateColor)(s.colorup.value(),i),o=(0,C.generateColor)(s.colordown.value(),i),a=(0,Qe.parseRgba)(n),l=a?100*(1-a[3]):0,h=(0,Qe.parseRgba)(o),c=h?100*(1-h[3]):0,u={items:this._items,barSpacing:r,colorup:n,colordown:o,colorBorderUp:(0,C.generateColor)("#000000",l),colorBorderDown:(0,C.generateColor)("#000000",c),minHeight:this._plotStyleInfo.minHeight,visibleItemsRange:{startItemIndex:e,endItemIndex:t}};this._updateItemsHeights(u);const d=new ge.CompositeRenderer;if(d.append(new it(u)),this._model.selection().isSelected(this._study)&&null!==this._selectionData){const e=this._selectionData;e.barSpacing=r,d.append(new rt(e))}this._renderer=d}_fillItemWithPointStyle(e,t,s){const i=(0,o.ensureDefined)(e.style);e.isUp?void 0!==t.colors[5]?i.color=(0,C.generateColor)((0,o.ensureDefined)(t.colors[5]),s):i.color=(0,C.generateColor)(this._study.properties().childs().styles.childs()[this._plotName].childs().colorup.value(),s):void 0!==t.colors[6]?i.color=(0,C.generateColor)((0,o.ensureDefined)(t.colors[6]),s):i.color=(0,C.generateColor)(this._study.properties().childs().styles.childs()[this._plotName].childs().colordown.value(),s)}_getValueForUpdating(e){const t=e.value[this._plotIndex+1];if(!t)return null;const s=e.index,i=t>0,{hiPlot:r,loPlot:n}=this._hiLoPlots(),a=this._study.offset(this._plotName),l=Math.min(s+a,(0,o.ensureNotNull)(this._series.data().last()).index);if(i){const e=this._getSeriesVal(n,l);if(null!==e)return e}else{const e=this._getSeriesVal(r,l);if(null!==e)return e}return null}_updateItem(e,t){const s=this._getValueForUpdating(e),i=e.value[this._plotIndex+1]>0;return this._items[t].origPrices.price=s??NaN,this._items[t].isUp=i,t+1}_createItem(e,t,s,i,r){const n={center:NaN,y:NaN,origPrices:{price:NaN,timePointIndex:NaN},origHeight:NaN};if(n.timePointIndex=e+r,!t)return n;const a=Math.min(e+r,(0,o.ensureNotNull)(this._series.data().last()).index),l=t>0;let h;if(l){const e=this._getSeriesVal(i,a);if(null===e)return n;h=e}else{const e=this._getSeriesVal(s,a);if(null===e)return n;h=e}return new et(e+r,h,t,l,{price:h,timePointIndex:e+r})}_dependsOnSeriesData(){return!0}_convertItemsToCoordinates(e,t,s,i){
this._convertItemsToCoordinatesImpl(e,t,s,i)}_updateItemsHeights(e){const t=this._study.properties().childs().styles.childs();let s=Math.abs((0,o.ensureDefined)(t[this._plotName].childs().minHeight?.value()??this._plotStyleInfo.minHeight)),i=Math.abs((0,o.ensureDefined)(t[this._plotName].childs().maxHeight?.value()??this._plotStyleInfo.maxHeight));if(s>i){const e=s;s=i,i=e}const r=this._items,n=e.visibleItemsRange?.startItemIndex??0,a=(e.visibleItemsRange?.endItemIndex??r.length)-1;let l=0;for(let e=n;e<=a;e++){const t=r[e],s=Math.abs(t.origHeight);s>l&&(l=s)}const h=(i-s)/l;for(let e=n;e<=a;e++){const t=r[e],i=Math.abs(t.origHeight);t.height=i*h+s}}}var ot=s(449524);class at extends Ie.StudyForceOverlayPlotView{constructor(e,t,s,i){super(t,s,i),this._bars=[],this._invalidated=!1,this._isMarkersEnabled=ye.enabled("source_selection_markers"),this._selectionData=null,this._ohlcPlotIndexes=new Map,this._study=e,this._isMarkersEnabled=ye.enabled("source_selection_markers"),this._colorProvider=(0,ve.createStudyPlotColorProvider)(e.metaInfo(),e.properties(),i),this._selectionIndexer=new xe.SelectionIndexes(s.timeScale());const r=this._study.metaInfo().plots;for(let e=0;e<r.length;e++){const t=r[e];"target"in t&&(t.target===this._plotName&&((0,B.isOhlcOpenPlot)(t)&&this._ohlcPlotIndexes.set(1,e),(0,B.isOhlcHighPlot)(t)&&this._ohlcPlotIndexes.set(2,e),(0,B.isOhlcLowPlot)(t)&&this._ohlcPlotIndexes.set(3,e),(0,B.isOhlcClosePlot)(t)&&this._ohlcPlotIndexes.set(4,e)))}}update(){this._invalidated=!0}items(){return this._bars}_updateImpl(){this._bars.length=0;const e=this._priceScale();if(this._model.timeScale().isEmpty()||null===e||e.isEmpty())return;const t=this._model.timeScale().visibleBarsStrictRange();if(null===t)return;let s=this._series.nearestIndex(t.firstBar(),O.PlotRowSearchMode.NearestRight);const i=this._series.nearestIndex(t.lastBar(),O.PlotRowSearchMode.NearestLeft);if(void 0===s||void 0===i)return;const r=this._study.getMinFirstBarIndexForPlot(this._plotName);if(r>i)return;s=Math.max(r,s);const n=this._study.data(),a=this._study.firstValue(void 0,this.isForceOverlay());if(null===a)return;const l=n.rangeIterator(s,i),h=(0,o.ensureDefined)(this._study.properties().childs().ohlcPlots).childs()[this._plotName].childs(),c=new Map,u=(e,t)=>{const s=e+"@"+t;if(!c.has(s)){const i=(0,C.generateColor)(e,t);return c.set(s,i),i}return c.get(s)},d=(0,Re.createEmptyStyle)();for(const e of l){let t=e.index;const s=e.value;t=Math.floor(t);let i=!0;const r=new Map;for(let e=1;e<=4;++e){const t=this._ohlcPlotIndexes.get(e);if(void 0===t){i=!1;break}const n=s[t+1];if(null==n){i=!1;break}r.set(e,n)}if(!i)continue;const n=(0,o.ensureDefined)(r.get(1)),a=(0,o.ensureDefined)(r.get(4)),l=(0,o.ensureDefined)(r.get(2)),c=(0,o.ensureDefined)(r.get(3)),p=Math.max(n,l,c,a),_=Math.min(n,l,c,a);let f=(0,o.ensureDefined)(u(h.color.value(),0));const m=this._colorProvider.getPlotPointStyle(s,d);void 0!==m.colors[0]&&(f=(0,o.ensureDefined)(m.colors[0]));const y={open:n,high:p,low:_,close:a,color:f,wickColor:m.colors[4],borderColor:m.colors[3],
hollow:null,center:NaN,left:NaN,right:NaN,timePointIndex:Math.round(t)};this._bars.push(y)}if(e.barPricesToCoordinates(this._bars,a),this._model.timeScale().fillBarBorders(this._bars),this._model.selection().isSelected(this._study)){const t=this._selectionIndexer.indexes();this._selectionData={points:[],hittestResult:Ke.HitTarget.Regular,bgColors:[],visible:!0,barSpacing:this._model.timeScale().barSpacing()};const s=(0,o.ensureNotNull)(this._model.paneForSource(this._study)).height(),i=(0,o.ensureDefined)(this._ohlcPlotIndexes.get(4));for(let r=0;r<t.length;r++){const n=t[r],o=this._study.data().valueAt(n);if(null===o)continue;const l=o[i+1];if(null==l)continue;const h=this._model.timeScale().indexToCoordinate(Math.floor(n)),c=e.priceToCoordinate(l,a);this._selectionData.points.push({point:new We.Point(h,c)}),this._selectionData.bgColors.push(this._model.backgroundColorAtYPercentFromTop(c/s))}}else this._selectionIndexer.clear()}_isOHLCPlotVisible(){return this._study.isPlotVisibleAt(this._plotName,1)}}class lt extends at{renderer(){if(!this._isOHLCPlotVisible())return null;this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={bars:this._bars,dontDrawOpen:this._series.properties().childs().barStyle.childs().dontDrawOpen.value(),thinBars:this._series.properties().childs().barStyle.childs().thinBars.value()},t=new ge.CompositeRenderer;return t.append(new ot.PaneRendererBars(e)),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&this._selectionData&&t.append(new we.SelectionRenderer(this._selectionData)),t}}var ht=s(559327);class ct extends at{renderer(){if(!this._isOHLCPlotVisible())return null;const e=this._priceScale();if(!e||e.isEmpty())return null;this._invalidated&&(this._updateImpl(),this._invalidated=!1);const t=(0,o.ensureDefined)(this._study.properties().childs().ohlcPlots).childs()[this._plotName].childs(),s=this._model.timeScale().barSpacing(),i={bars:this._bars,barSpacing:s,wickVisible:t.drawWick.value(),bodyVisible:!0,borderVisible:t.drawBorder.value(),barWidth:(0,qe.optimalBarWidth)(s),borderColor:t.borderColor.value(),wickColor:t.wickColor.value(),isPriceScaleInverted:e.isInverted()},r=new ge.CompositeRenderer;return r.append(new ht.PaneRendererCandles(i)),this._model.selection().isSelected(this._study)&&this._isMarkersEnabled&&this._selectionData&&r.append(new we.SelectionRenderer(this._selectionData)),r}}var ut=s(95370),dt=s(703614),pt=s(345159),_t=s(666574);class ft extends pt.HorizontalLinePaneView{constructor(e,t){super(),this._lineRendererData.linestyle=_t.LINESTYLE_DOTTED,this._study=e,this._plotName=t}_updateImpl(){this._lineRendererData.visible=!1;const e=this._study.properties().childs().styles.childs()[this._plotName].childs();if(!e.trackPrice.value()||!this._study.isPlotVisibleAt(this._plotName,1))return;const t=this._study.lastValueData(this._plotName,!0);t.noData||(this._lineRendererData.visible=!0,this._lineRendererData.y=t.coordinate,this._lineRendererData.color=t.color,this._lineRendererData.linewidth=e.linewidth.value())}}
var mt=s(512230),yt=s(19932),gt=s(781298);const St={type:0,color:"transparent"};class bt extends gt.AbstractFilledAreaPaneView{constructor(e,t,s,i){super(e,t,s),this._palettesInfo={},this._gradientPropsStateCache=null,this._rgbaFromInteger=(0,yt.rgbaFromIntegerCached)();const r=this._source.metaInfo();this._isRGB=Boolean(r.isRGB),this._isHlineFill="hline_hline"===s.type,(0,o.assert)(this._isHlineFill||"plot_plot"===s.type,"Wrong filledArea type: "+s.type),this._isHlineFill&&this._initBandIndexes(s.objAId,s.objBId),this._fillMetaInfo=s,this._fillStyleProps=i,this._gradientFillType=i.hasChild("fillType")&&"gradient"===i.childs().fillType?.value(),this._gradientStaticState={color1:s.topColor,color2:s.bottomColor,value1:s.topValue,value2:s.bottomValue},this._hasAllGradientRequiredProps=this._gradientFillType&&(void 0!==this._gradientStaticState.color1||i.hasChild("topColor")||void 0!==this._gradientStaticState.color2||i.hasChild("bottomColor"))&&(void 0!==this._gradientStaticState.value1||i.hasChild("topValue"))&&(void 0!==this._gradientStaticState.value2||i.hasChild("bottomValue"));const n=()=>this._colorPlotIndex=this._colorPlotIndex??{type:1};for(let t=0;t<r.plots.length;++t){const i=r.plots[t];if(((0,B.isColorerPlot)(i)||(0,B.isDataPlot)(i))&&i.target===s.id){if((0,B.isColorerPlot)(i)){let s;void 0!==i.targetField?"topColor"===i.targetField?(n().colorIndexOrRgba1=t,s="color1"):"bottomColor"===i.targetField&&(n().colorIndexOrRgba2=t,s="color2"):this._colorPlotIndex={type:0,colorIndexOrRgba:t},(0,B.isPaletteColorerPlot)(i)&&(this._palettesInfo[s??"color"]={map:(0,o.ensureDefined)((0,o.ensureDefined)(r.palettes)[i.palette]?.valToIndex),values:e.properties().palettes[i.palette].colors})}else(0,B.isDataPlot)(i)&&("topValue"===i.targetField?n().valueIndex1=t:"bottomValue"===i.targetField&&(n().valueIndex2=t));if(0===this._colorPlotIndex?.type)break}}}update(e){super.update(e),this._gradientPropsStateCache=null}isForceOverlay(){return!!this._source.metaInfo().isPlotForceOverlay(this._plotAId())}_firstValue(){const e=this.isForceOverlay();return this._source.firstValue(void 0,e)}_minFirstBarIndex(){return this._source.getMinFirstBarIndexForPlot(this._fillMetaInfo.id)}_getColorByPlotValue(e){if(0===e.type){let t;if(null==e.colorIndexOrRgba)return null;if(this._isRGB)t=this._rgbaFromInteger(e.colorIndexOrRgba);else{const s=(0,o.ensureDefined)(this._palettesInfo.color),i=(0,o.ensureDefined)(s.map[e.colorIndexOrRgba]);t=s.values[i]?.childs().color.value()}return{type:0,color:t}}const t=this._gradientColorPropsState();let s,i;if(this._isRGB)null!=e.colorIndexOrRgba1&&(s=this._rgbaFromInteger(e.colorIndexOrRgba1)),null!=e.colorIndexOrRgba2&&(i=this._rgbaFromInteger(e.colorIndexOrRgba2));else{if(null!=e.colorIndexOrRgba1){const t=(0,o.ensureDefined)(this._palettesInfo.color1);s=t.values[(0,o.ensureDefined)(t.map[e.colorIndexOrRgba1])].childs().color.value()}if(null!=e.colorIndexOrRgba2){const t=(0,o.ensureDefined)(this._palettesInfo.color2);i=t.values[(0,o.ensureDefined)(t.map[e.colorIndexOrRgba2])].childs().color.value()}}
const r=e.value1??t.value1,n=e.value2??t.value2;return s=s??t.color1,i=i??t.color2,void 0===r||void 0===n||void 0===s&&void 0===i?null:{type:1,color1:s,color2:i,value1:r,value2:n,coordinate1:NaN,coordinate2:NaN}}_plotAId(){return this._fillMetaInfo.objAId}_plotBId(){return this._fillMetaInfo.objBId}_commonColor(){const e=this._fillStyleProps.childs();if(this._gradientFillType){if(!this._hasAllGradientRequiredProps)return St;const e=this._gradientColorPropsState();return{type:1,color1:e.color1,color2:e.color2,value1:e.value1,value2:e.value2,coordinate1:NaN,coordinate2:NaN}}return{type:0,color:e.color.value()}}_transparency(){return this._fillStyleProps.childs().transparency?.value()??0}_visible(){return this._fillStyleProps.childs().visible.value()}_priceScale(){return this.isForceOverlay()?this._model.mainSeries().priceScale():this._source.priceScale()}_initBandIndexes(e,t){this._bandAKey=null,this._bandBKey=null;const s=this._source.metaInfo().bands;if(void 0!==s)for(let i=0;i<s.length;++i){const r=s[i];null!==this._bandAKey||r.id!==e?null===this._bandBKey&&r.id===t&&(this._bandBKey=i):this._bandAKey=i}}_gradientColorPropsState(){if(null===this._gradientPropsStateCache){const e=this._fillStyleProps.state();this._gradientPropsStateCache={color1:this._gradientStaticState.color1??e.topColor,color2:this._gradientStaticState.color2??e.bottomColor,value1:this._gradientStaticState.value1??e.topValue,value2:this._gradientStaticState.value2??e.bottomValue}}return this._gradientPropsStateCache}}var vt=s(193938),It=s(467841);class Pt{constructor(e,t){this._invalidated=!0,this._lineRenderer=new It.HorizontalLineRenderer,this._source=t,this._points=[new We.Point(-1,-1)],this._invalidated=!0,this._properties=e}update(){this._invalidated=!0}renderer(){this._invalidated&&(this._updateImpl(),this._invalidated=!1);const e={y:this._points[0].y,color:this._properties.childs().color.value(),linewidth:this._properties.childs().linewidth.value(),linestyle:this._properties.childs().linestyle.value()};return this._lineRenderer.setData(e),this._lineRenderer}_updateImpl(){const e=this._source.priceScale();if(!e||e.isEmpty())return void(this._points[0]=new We.Point(-1,-1));const t=this._properties.childs().value.value(),s=this._source.firstValue(),i=(0,W.isNumber)(t)&&null!==s?e.priceToCoordinate(t,s):NaN;this._points[0]=new We.Point(-1,i)}}var wt=s(367637);class Ct extends wt.MediaCoordinatesPaneRenderer{constructor(){super(),this._data=null,this._data=null}setData(e=null){this._data=e}hitTest(){return null}_drawImpl(e){if(null===this._data||0===this._data.points.length)return;const t=e.context,s=e.mediaSize.width;if(this._data.gradient){const e=t.createLinearGradient(0,this._data.coordinate1,0,this._data.coordinate2);e.addColorStop(0,this._data.backColor1??"transparent"),e.addColorStop(1,this._data.backColor2??"transparent"),t.fillStyle=e}else t.fillStyle=this._data.backcolor;const i=Math.min(this._data.points[0],this._data.points[1]),r=Math.max(this._data.points[0],this._data.points[1]);t.fillRect(0,i,s,r-i)}}class Vt{constructor(e){
this._bandBgRenderer=new Ct,this._invalidated=!0,this._source=e}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._bandBgRenderer}_updateImpl(){this._bandBgRenderer.setData(null);const e=this._source.properties().childs(),t=e.bands;if(t.childCount()<2)return;const s=e.bandsBackground;if(!s?.childs().fillBackground.value())return;const i=t[0].childs(),r=t[1].childs(),n=this._source.priceScale(),a=this._source.firstValue();if(!n||n.isEmpty()||null===a)return;const l=[n.priceToCoordinate(i.value.value(),a),n.priceToCoordinate(r.value.value(),a)],h=(0,o.ensureDefined)(e.bandsBackground).childs(),c=(0,Ve.clamp)(h.transparency?.value()??0,0,100);this._bandBgRenderer.setData({gradient:!1,points:l,backcolor:(0,C.generateColor)(h.backgroundColor.value(),c)})}}class xt{constructor(e,t,s){this._bandBgRenderer=new Ct,this._bandAKey=null,this._bandBKey=null,this._invalidated=!0,this._source=e,(0,o.assert)("hline_hline"===t.type,"Wrong filledArea type: "+t.type),this._initBandIndexes(t.objAId,t.objBId),this._fillStyleProps=s,this._bandBgRenderer=new Ct,this._gradientFillType=s.hasChild("fillType")&&"gradient"===s.childs().fillType?.value(),this._gradientStaticState={color1:t.topColor,color2:t.bottomColor,value1:t.topValue,value2:t.bottomValue}}update(){this._invalidated=!0}renderer(){return this._invalidated&&(this._updateImpl(),this._invalidated=!1),this._bandBgRenderer}_updateImpl(){if(this._bandBgRenderer.setData(null),!this._fillStyleProps.childs().visible.value())return;if(null===this._bandAKey||null===this._bandBKey)return;const e=(0,o.ensureDefined)(this._source.properties().childs().bands),t=e.childs()[this._bandAKey].childs(),s=e.childs()[this._bandBKey].childs(),i=this._source.priceScale(),r=this._source.firstValue();if(!i||i.isEmpty()||null===r)return;const n=[i.priceToCoordinate(t.value.value(),r),i.priceToCoordinate(s.value.value(),r)],a=(0,Ve.clamp)(this._fillStyleProps.childs().transparency?.value()??0,0,100);let l;const h=this._fillStyleProps.childs();if(this._gradientFillType){const e=this._gradientStaticState,t=h,s=e.value1??t.topValue?.value(),o=e.value2??t.bottomValue?.value();if(void 0===s||void 0===o)return;const c=e.color1??t.topColor?.value(),u=e.color2??t.bottomColor?.value();if(void 0===c&&void 0===u)return;l={gradient:!0,points:n,backColor1:c&&(0,C.generateColor)(c,a),backColor2:u&&(0,C.generateColor)(u,a),coordinate1:i.priceToCoordinate(s,r),coordinate2:i.priceToCoordinate(o,r)}}else l={gradient:!1,points:n,backcolor:(0,C.generateColor)(h.color.value(),a)};this._bandBgRenderer.setData(l)}_initBandIndexes(e,t){this._bandAKey=null,this._bandBKey=null;(0,o.ensureDefined)(this._source.metaInfo().bands).forEach(((s,i)=>{null===this._bandAKey&&s.id===e&&(this._bandAKey=i),null===this._bandBKey&&s.id===t&&(this._bandBKey=i)}))}}var At=s(757402),Rt=s(412788),Mt=s(219849),Dt=s(169532),Tt=s(375397),Ot=s(643322),Nt=s(975179),Ft=s(546821),kt=s(125624),Bt=s(336928),Et=s(200441);class Lt extends Et.AbstractBarColorer{constructor(e,t){super(),
this._rgbaFromInteger=(0,yt.rgbaFromIntegerCached)(),this._study=e,this._plotIndex=t}applyBarStyle(e,t,s,i){if(t)return s;const r=this._study.properties().childs();if(!r.visible.value())return s;const n=this._study.metaInfo(),a=this._study.data();if(!a||0===a.size())return s;const l=n.plots[this._plotIndex],h=this._getOffset();if(this._study.getMinFirstBarIndexForPlot(l.id)>e+h)return s;if(0===r.styles.childs()[l.id].childs().display.value())return s;const c=a.valueAt(e-h);if(null===c)return s;let u=c[this._plotIndex+1];if(null==u)return s;if(u=Math.round(u),n.isRGB)s.barColor=this._rgbaFromInteger(u),s.upColor=s.barColor,s.downColor=s.barColor;else{const e=n.plots[this._plotIndex];if("palette"in e){const t=e.palette,i=r.palettes.childs()[t],a=(0,o.ensureDefined)(n.palettes?.[t]),l=a.valToIndex?(0,o.ensureDefined)(a.valToIndex[u]):u,h=i.childs().colors.childs()[l].childs().color.value();s.barColor=h,s.upColor=h,s.downColor=h}}return s}firstColoredBar(e){let t=e;for(const s of this._backColorers)t=Math.min(t,s.firstColoredBar(e)??1/0);const s=this._getOffset();t=Math.min(t,e+s);const i=this._getBars().firstIndex(),r=Math.max(t,i??-1/0),n=this._study.metaInfo().plots[this._plotIndex];return Math.max(this._study.getMinFirstBarIndexForPlot(n.id),r)}_getBars(){return this._study.series().bars()}_getOffset(){const e=this._study.metaInfo().plots[this._plotIndex];return this._study.offset(e.id)}}var Ht=s(251954),Ut=s(911144),zt=s(735211),Gt=s(984217);class jt extends ut.PanePriceAxisView{constructor(e,t,s,i){super(e,t,s),this._dataSource=t,this._isForceOverlay=t.metaInfo().isPlotForceOverlay(i)}_position(){const e=this._isForceOverlay?this._chartModel.mainPane():this._chartModel.paneForSource(this._dataSource);if(null===e)return null;const t=this._isForceOverlay?this._chartModel.mainSeries().priceScale():this._dataSource.priceScale();if(null===t)return null;let s=e.priceScalePosition(t);return"overlay"===s&&(s=e.priceScalePosition(e.defaultPriceScale())),"overlay"===s?null:s}}var Wt=s(758697),$t=s(941654),Kt=s(903424);const qt=(0,l.getLogger)("Chart.Study"),Yt=a.t(null,void 0,s(314285));const Jt={symbolsForDisplay:!1,symbolsForChartApi:!0,skipHiddenInputs:!1,skipFakeInputs:!1,skipBooleanInputs:!1,asObject:!0,skippedGroups:[],skippedInputs:[],noExchanges:!1,noResolution:!1,keepOptionalSymbolsEmpty:!1,skipColorInputs:!1,skipTimeInputs:!1,skipOptionalEmptySymbolInputs:!1,skipTextareaInputs:!1,priceInputsForDisplay:!1},Zt={symbolsForDisplay:!1,symbolsForChartApi:!0,skipHiddenInputs:!0,skipFakeInputs:!1,skipBooleanInputs:!1,skippedGroups:[],skippedInputs:[],noExchanges:!1,noResolution:!1,keepOptionalSymbolsEmpty:!1,skipColorInputs:!1,skipTimeInputs:!1,skipOptionalEmptySymbolInputs:!1,skipTextareaInputs:!1,priceInputsForDisplay:!1,fakeInputsForDisplay:!1,doNotSkipHiddenWithMigrate:!1,onlyAtomValues:!0,patchSosInputs:!1},Xt=ye.enabled("study_symbol_ticker_description"),Qt=ye.enabled("hide_main_series_symbol_from_indicator_legend"),es=ye.enabled("datasource_copypaste"),ts=ye.enabled("hide_unresolved_symbols_in_legend")
;function ss(e,t){const s=e.plots[t];if(!s||!(0,B.isOhlcPlot)(s))return!1;const i=s.target,r=e.defaults.styles&&e.defaults.styles[i],n=e.defaults.ohlcPlots&&e.defaults.ohlcPlots[i],o=e.ohlcPlots&&e.ohlcPlots[i];return r&&(0,B.isOhlcPlotStyleBars)(r)||n&&(0,B.isOhlcPlotStyleBars)(n)||!!o&&(0,B.isOhlcPlotStyleBars)(o)}function is(e,t){const s=e.plots[t];if(!s||!(0,B.isOhlcPlot)(s))return!1;const i=s.target,r=e.defaults.styles&&e.defaults.styles[i],n=e.defaults.ohlcPlots&&e.defaults.ohlcPlots[i],o=e.ohlcPlots&&e.ohlcPlots[i];return r&&(0,B.isOhlcPlotStyleCandles)(r)||n&&(0,B.isOhlcPlotStyleCandles)(n)||!!o&&(0,B.isOhlcPlotStyleCandles)(o)}function rs(e,t){(0,o.assert)(void 0!==e,"zOrder must be defined"),(0,o.assert)(!t.has(e),"zOrder must be unique")}function ns(e,t){return e.plots.some((e=>((0,B.isColorerPlot)(e)||(0,B.isDataPlot)(e))&&e.target===t))}function os(e,t,s){let i=0,r=0;return e.inputs.filter((e=>"source"===e.type)).forEach((e=>{(0,_.getInputValue)(s[e.id]).includes("$")&&i++,(0,_.getInputValue)(t[e.id]).includes("$")&&r++})),Math.sign(r)-Math.sign(i)}function as(e){const t=new Set;for(const s of e.parentSources())for(const e of as(s))t.add(e);return t.add(e),Array.from(t)}function ls(e){return"inherit"===e.type&&(e.type="price"),e}function hs(e,t,s,i){if(null!==t)switch(e.type){case"inherit":case"price":return new zt.PriceFormatter({priceScale:t});case"volume":return(0,Wt.getVolumeFormatter)(Math.log10(t));case"percent":return(0,Wt.getPercentageFormatter)(Math.log10(t))}if("inherit"===e.type)return null;const r=(0,W.isNumber)(e.precision)?Math.pow(10,e.precision):void 0;switch(e.type){case"price":return new zt.PriceFormatter({priceScale:r});case"volume":{let t=e.precision;return void 0===t&&(t=s&&(0,W.isNumber)(s.volume_precision)?s.volume_precision:0),(0,Wt.getVolumeFormatter)(t)}case"percent":return(0,Wt.getPercentageFormatter)(void 0===r?void 0:Math.log10(r));default:return qt.logWarn(`Unsupported format type: ${e.type}`),null}}const cs=new Set(["first_visible_bar_time","last_visible_bar_time","subscribeRealtime"]);class us extends A.PriceDataSource{constructor(e,t,s,i,r){super(e),this._onStart=new w.Delegate,this._restarting=!1,this._paneViews=[],this._forceOverlaysPaneViews=[],this._legendView=null,this._priceAxisViews=[],this._forceOverlayPriceAxisViews=[],this._priceAxisViewsBase=[],this._resolvedSymbols={},this._resolvedSymbolsByInput={},this._priceLinesAxisViews=[],this._labelPaneViews=[],this._forceOverlayLabelPaneViews=[],this._ownFirstValue=null,this._formatter=null,this._defaultFormatter=null,this._dataUpdated=new w.Delegate,this._currencySourceSymbolInputProperty=null,this._onHibernationStateChange=new w.Delegate,this._symbolsResolved=new w.Delegate,this._statusChanged=new w.Delegate,this._inputsAnchorsPaneView=null,this._inputsLinesPaneView=null,this._inputsTimeAxisPaneViews=[],this._inputsPriceAxisPaneViews=[],this._sources=[],this._status={type:At.StudyStatusType.Undefined},this._compileActiveStatus=null,this._compileErrorStatus=null,this._wasCompletedBefore=!1,this._studyId=null,
this._isSubscribedToSessionId=!1,this._titleStrCache={},this._titleInPartsCache={},this._children=[],this._graphicsPriceAxisViews=[],this._plotOffsets={},this._ongoingDataUpdate=Promise.resolve(),this._studyModified=!1,this._tagsChanged=new w.Delegate,this._studyName="",this._turnaround="st0",this._pendingResolveSymbols=new Map,this._onIsActualIntervalChange=new w.Delegate,this._childStudyByRebind=new w.Delegate,this._lastNonEmptyPlotRowCache={},this._startMovingPoint=null,this._processHibernateBound=this.processHibernate.bind(this,1),this._maxOffset=new Tt.WatchedValue(0),this._currencySourceSymbolInfo=null,this._graphicsPriceRangeGroups=null,this._graphicsViewsReady=!1,this._visibleTimeRangeInputs=null,this._turnaroundCounter=0,this._deferredPinePatchProps=!1,this._propertiesPatched=Promise.resolve(),this._aboutToBeDestroyed=new w.Delegate,this._definitionsViewModel=null,this._plotFormatters=new Map,this._showPineVersionInStatusLine=new Tt.WatchedValue(!1).spawn(),this._pineSourceCodeModel=null,this._onParentSourcesChanges=new w.Delegate,this._statusChangesSubscriber={},this._calculationTime=new Tt.WatchedValue(0),this._chartApi=e.chartApi(),this._properties=t,this._metaInfo=i,this._hideMatches=i.inputs.filter((e=>e.hideWhenPlotsHidden)).map((e=>({id:e.id,plotIds:e.hideWhenPlotsHidden||[]}))),this._series=this._model.mainSeries(),this._series.onIntervalChanged().subscribe(this,this._calcIsActualInterval),this._series.alertCreationAvailable().subscribe(this._updateAlertCreationAvailable.bind(this)),this._showStudyArgumentsProperty=e.properties().childs().paneProperties.childs().legendProperties.childs().showStudyArguments,e.collapsed().subscribe(this._processHibernateBound),this._sources=s,D.StudyMetaInfo.setChildStudyMetaInfoPropertiesSourceId(i,this._sources[0]?.id(),t),s.forEach((e=>{e.setChild(this)})),[this._series,...s].forEach((e=>{e.currencyChanged().subscribe(this,this._onSourceCurrencyChanged),e.unitChanged().subscribe(this,this._onSourceUnitChanged),e.priceRangeReadyChanged().subscribe(this,this._onSourcePriceRangeReadyChanged),e.formatterChanged().subscribe(this,this._onSourceFormatterChanged),e.priceStepChanged().subscribe(this,this._onSourcePriceStepChanged)})),Xt&&this._model.mainSeries().properties().childs().statusViewStyle.childs().symbolTextSource.listeners().subscribe(this,(()=>{this.invalidateTitleCache(!0)}));const n=this._properties.childs();for(const e of D.StudyMetaInfo.getSourceInputIds(i))n.inputs.childs()[e]?.subscribe(this,this._onSourceInputChanged);this._properties.subscribe(this,this._onPropertiesChanged),n.visible.subscribe(this,this._visibleChanged),n.visible.subscribe(this,(()=>this.processHibernate())),n.intervalsVisibilities.subscribe(this,this._calcIsActualInterval),n.inputs.listeners().subscribe(this,this._updateMaxOffsetValue),void 0!==n.offsets&&n.offsets.listeners().subscribe(this,this._updateMaxOffsetValue),void 0!==n.offset&&n.offset.listeners().subscribe(this,this._updateMaxOffsetValue),L.hideAllIndicators().subscribe(this,this._visibleChanged)
;for(let e=0;e<this._metaInfo.plots.length;e++){const t=this._metaInfo.plots[e].id,s=n.styles.childs()[t];s?.childs().display.subscribe(this,(()=>{this.processHibernate(),this.invalidateTitleCache()}))}for(const e of Object.keys(this._metaInfo.graphics))for(const t of Object.keys(this._metaInfo.graphics[e])){const s=n.graphics.childs()[e]?.childs()[t];s&&s.childs().visible&&(0,o.ensureDefined)(s.childs().visible).subscribe(this,(()=>this.processHibernate()))}this._isActualInterval=(0,Rt.isActualInterval)(this._series.intervalObj(),n.intervalsVisibilities),this._initializeStudyInputsPaneViews(),this._handler=e=>this._onData(e),this._valuesProvider=new Ut.StudyValuesProvider(this,e),this._graphicsPriceRangeGroups=ne(this),this._graphics=new T.LiveStudyGraphics(i.graphics),this._signlePerformanceValue=(0,pe.createWVFromGetterAndSubscriptions)((()=>Array.from((0,o.ensureDefined)(this._graphics.performance().get("performance")))[0]??null),[(0,o.ensureDefined)(this._graphics.observablePerformance().get("performance")).changed(),(0,o.ensureDefined)(this._graphics.observablePerformance().get("performance")).cleared()]),this._chartApi=e.chartApi(),this._invalidateLastNonEmptyPlotRowCache(),this._data=new M.PlotList((0,Gt.studyPlotFunctionMap)(this._metaInfo),Gt.studyEmptyPlotValuePredicate),this._createViews(),this._recreatePriceFormattingDependencies(this._series.symbolInfo()),n.precision.subscribe(this,this._onFormatterPropsChanged),this._showStudyArgumentsProperty.subscribe(this,(()=>this.invalidateTitleCache(!0))),n.inputs.listeners().subscribe(this,(()=>this.invalidateTitleCache(!0))),ye.enabled("update_study_formatter_on_symbol_resolve")&&e.mainSeries().dataEvents().symbolResolved().subscribe(this,this._recreatePriceFormattingDependencies),e.mainSeries().dataEvents().symbolResolved().subscribe(this,(()=>this.invalidateTitleCache(!0)));const a=new Set;if(this._simplePlotsCount=i.plots.filter(((e,t)=>{if((0,B.isLinePlot)(e))return!0;if((0,B.isOhlcPlot)(e)){const t=e.target;return!a.has(t)&&(a.add(t),!0)}return!1})).length,this.hasBarColorer()&&n.visible.listeners().subscribe(this,(()=>e.mainSeries().invalidateBarStylesCache)),this._definitionsViewModel=null,this._updateMaxOffsetValue(),i.inputs.some((e=>cs.has(e.id)))){this._visibleTimeRangeInputs=e.visibleRangeStudiesInputs().spawn();const t=this._visibleTimeRangeInputs.value();let s=null!==t;this._visibleTimeRangeInputs.subscribe((e=>{const t=()=>{this._onVisibleTimeRangeInputsChanged(e),s!==(null!==e)&&(s=null!==e,!s||this._restarting||this.isStarted()||this.start(!0))};this._statusChanged.unsubscribeAll(this._statusChangesSubscriber),this._status.type===At.StudyStatusType.Loading?this._statusChanged.subscribe(this._statusChangesSubscriber,t,!0):t()})),t&&this._updateVisibleTimeRangeInputs(t,!1)}if((0,de.isCountedUserScript)(i)&&(this._showPineVersionInStatusLine=(0,Ot.combine)((()=>(0,de.userScriptVersionsCount)(i.scriptIdPart)>1),(0,de.userScriptsOnLayout)().weakReference()),this._showPineVersionInStatusLine.subscribe((()=>{this.invalidateTitleCache(),
e.updateSource(this)}))),!r&&i.TVScriptMetaInfoExprs&&i.defaults.inputs){const e=this.inputs();for(const t of i.inputs)if(!t.isHidden&&!(0,_.isStudyInputDependsOnChart)(t)&&i.defaults.inputs[t.id]!==e[t.id]){this._deferredPinePatchProps=!0,this._oldStudyInputs=this._prepareInputs(Zt),this._oldStudyInputs[t.id]=i.defaults.inputs[t.id];break}}this._properties.setNameInOwner((0,$t.propertyPathForSource)(this))}destroy(){this._signlePerformanceValue?.destroy(),this._aboutToBeDestroyed.fire(),null!==this._definitionsViewModel&&(this._definitionsViewModel.destroy(),this._definitionsViewModel=null),this._showStudyArgumentsProperty.unsubscribeAll(this),this._model.mainSeries().dataEvents().symbolResolved().unsubscribeAll(this);this.parentSources().forEach((e=>{e.currencyChanged().unsubscribeAll(this),e.unitChanged().unsubscribeAll(this),e.priceRangeReadyChanged().unsubscribeAll(this),e.formatterChanged().unsubscribeAll(this),e.priceStepChanged().unsubscribeAll(this)})),this._series.properties().childs().statusViewStyle.childs().symbolTextSource.unsubscribeAll(this),this._series.onIntervalChanged().unsubscribeAll(this),this._series.alertCreationAvailable().unsubscribe(this._updateAlertCreationAvailable),this.formatterChanged().unsubscribe(this,this.invalidateTitleCache),L.hideAllIndicators().unsubscribe(this,this._visibleChanged),this._model.collapsed().unsubscribe(this._processHibernateBound),null!==this._currencySourceSymbolInputProperty&&this._currencySourceSymbolInputProperty.unsubscribeAll(this),this._legendView?.destroy(),this._pineSourceCodeModel?.get()?.destroy(),this._pineSourceCodeModel?.destroy(),this._visibleTimeRangeInputs?.destroy(),this._showPineVersionInStatusLine.destroy(),super.destroy()}setId(e){super.setId(e),this._properties.setNameInOwner((0,$t.propertyPathForSource)(this))}properties(){return this._properties}propertiesPatched(){return this._propertiesPatched}isDraggable(){return!this._metaInfo.linkedToSeries}logs(){return this._metaInfo.graphics.logs&&this._graphics instanceof T.LiveStudyGraphics?(0,o.ensureDefined)(this._graphics.observableLogs().get("logs")):null}logLevelMask(){const e=this._properties.childs().inputs.childs().__log_level.value();if(!(0,W.isNumber)(e)||e<0||e>7)throw new Error(`Value of log level is unexpected, current value is ${e}, but expected values from 0 to 7`);return{error:Boolean(1&e),warning:Boolean(2&e),info:Boolean(4&e)}}setLogLevelMask(e){const t=(Number(e.error)&&1)|(Number(e.warning)&&2)|(Number(e.info)&&4);this._properties.childs().inputs.childs().__log_level.setValue(t)}performance(){return this._graphics instanceof T.LiveStudyGraphics?this._signlePerformanceValue:new Tt.WatchedValue(null)}profilingEnabled(){return!!this._properties.childs().inputs.childs().__profile?.value()}enableProfiling(e){this._properties.childs().inputs.childs().__profile?.setValue(e)}onAboutToBeDestroyed(){return this._aboutToBeDestroyed}priceScale(e){return e?this._model.mainSeries().priceScale():super.priceScale()}lastValueData(e,t,s){const i={noData:!0
},r=this.metaInfo().isPlotForceOverlay(e),n=r?this._model.mainSeries().priceScale():this.priceScale();if(this._model.timeScale().isEmpty()||null===n||n.isEmpty()||this.data().isEmpty())return i;const o=this._model.timeScale().visibleBarsStrictRange(),a=this.firstValue(!0,r);if(null===o||null===a)return i;if(!this._properties.childs().visible.value())return i;const l=this._properties.childs().styles,h=this._properties.childs().ohlcPlots;let c,u;if(l&&l.childs()[e]&&(c=l.childs()[e]),h&&h.childs()[e]&&(c=h.childs()[e]),!c||0===c.childs().display.value())return i;const d=this.metaInfo().plots;for(u=0;u<d.length;u++){const t=d[u];if(t.id===e||(0,B.isOhlcClosePlot)(t)&&t.target===e)break}const p=u+1,_=this.offset(e),f=this.nearestIndex(o.lastBar()-_,O.PlotRowSearchMode.NearestLeft,p);if(void 0===f)return i;const m=this._lastNonEmptyPlotRow(p),y=null!==m&&o.contains(m.index),g=null!==m?m.value:null,S=t||y?g:this.data().valueAt(f);if(!S||!(0,W.isNumber)(S[p]))return i;const b=S[p],v=this._valuesProvider.getPlotColor(u,S),I=n.priceToCoordinate(b,a),P=this.plotFormatter(e).format(b),w={...n.getFormattedValues(b,a,void 0,P),noData:!1,color:v,floatCoordinate:I,coordinate:I};return s&&(w.price=b),w}isFailed(){return this.status().type===At.StudyStatusType.Error}isLoading(){return this.status().type===At.StudyStatusType.Loading}isCompleted(){return this.status().type===At.StudyStatusType.Completed}isSymbolInvalid(){return this._status.type===At.StudyStatusType.Error&&this._status.errorDescription.error===Yt}series(){return this._series}model(){return this._model}state(e,t){const s=(0,o.ensureNotNull)((0,h.getStudyClassName)(this.constructor)),i=this.metaInfo(),r={type:s,id:this.id(),state:this.properties().state(),zorder:this.zorder(),ownFirstValue:this.isVisible()?null:this._ownFirstValue,metaInfo:i.state()},n=this._sources.map((e=>e.id()));if(n.length&&(r.parentSources=n),e){let e=this.data();const t=this._model.timeScale(),s=this._seriesDataRangeToSave(e);null!==s&&(e=e.range(s.firstBar(),s.lastBar())),r.data=e.state(),r.data.symbols=this._resolvedSymbols,r.data.graphics=(0,T.saveStudyGraphics)(this.graphics(),t.visibleBarsStrictRange()),r.data.plotOffsets=this._plotOffsets}this.ownerSource()&&(r.ownerSource=this.ownerSource()?.id());for(let e=0;e<i.inputs.length;e++)if("bar_time"===i.inputs[e].type){const t=i.inputs[e].id,s=r.state.inputs[t];if(s<0){const e=this._rightOffsetToUnixTime(-s);r.state.inputs[t]=e&&e>=0?e:0}}if(r.state?.inputs){const e=r.metaInfo.inputs.find((e=>"ILScript"===e.name));e&&delete r.state.inputs[e.id],delete r.state.inputs.__log_level,delete r.state.inputs.__profile}const a=this.stateCustomFields();var l;return a&&(r.customFields=a),t&&(l=r).metaInfo&&l.metaInfo.scriptIdPart&&l.metaInfo.scriptIdPart.startsWith("USER;")&&(function(e){if(!e.metaInfo)return;const t=e.metaInfo.scriptIdPart;if(!t)return;const s=t.split(";")[0],i=e.metaInfo;i.id=(i.id||"").replace(t,s),i.fullId=(i.fullId||"").replace(t,s),i.name=(i.name||"").replace(t,s),i.shortId=(i.shortId||"").replace(t,s),
i.scriptIdPart=(i.scriptIdPart||"").replace(t,s),e.state&&(e.state.id=(e.state.id||"").replace(t,s),e.state.name=(e.state.name||"").replace(t,s),e.state.scriptIdPart=(e.state.scriptIdPart||"").replace(t,s))}(l),function(e){const t=(e.metaInfo&&e.metaInfo.inputs||[]).find((e=>"ILScript"===e.name));t&&(t.defval="",e.state&&e.state.inputs&&(e.state.inputs[t.id]=""),e.metaInfo.defaults.inputs&&(e.metaInfo.defaults.inputs[t.id]=""))}(l)),r}stateCustomFields(){if(this._compileErrorStatus)return{compileErrorDescription:this._compileErrorStatus.errorDescription}}restoreStateCustomFields(e){const t=e.compileErrorDescription;t&&this.setErrorCompilation([(0,o.ensureDefined)(t.editorError)])}restoreData(e){this._invalidateLastNonEmptyPlotRowCache(),this.data().restoreState(e),this._resolvedSymbols=e.symbols??{},this._graphics=e.graphics?(0,T.loadStudyGraphics)(e.graphics):(0,T.emptyStudyGraphics)(),this._postProcessGraphics(),this._plotOffsets=e.plotOffsets??{},this._setStatus({type:At.StudyStatusType.Completed},!0)}hasStateForAlert(){return ue.alertsAvailable&&!this.isFailed()&&!this._metaInfo.isTVLibrary&&this._series.alertCreationAvailable().value()&&(this._hasAlertConditions()||this._hasAvailableAlertPlots()||this._hasAlertFunction())}stateForAlert(){const e=(0,o.ensureNotNull)(this._alertMetaInfo()),t=this._plotsForAlert(),s=this._collectDepsForAlert(),i=s.idForAlert,r=s.studyDependencies,n=s.inputsForAlert,a=(this.priceScale()||this.model().mainSeries().priceScale()).formatter(),l=a?d.FormattersSerializer.serialize(a):null,u={id:i,uniqueId:i,type:(0,o.ensureNotNull)((0,h.getStudyClassName)(this.constructor)),title:(0,c.clean)(this._title($.TitleDisplayTarget.Alerts,!1,{},!1,!1,!0),!0),shortTitle:(0,c.clean)(this._title($.TitleDisplayTarget.Alerts,!0,{},!1,!1,!0),!0),shortDescription:(0,c.clean)(e.shortDescription||"Study",!0),fullId:e.fullId,isTVScript:Boolean(e.isTVScript),isTVScriptStrategy:Boolean(e.isTVScriptStrategy),isTVLibrary:Boolean(e.isTVLibrary),hasAlertFunction:Boolean(e.hasAlertFunction),plots:t,inputs:n,alerts:e.alerts,scriptIdPart:e.scriptIdPart,scriptVersion:e.pine?e.pine.version:"-1",studyDependencies:r,formatter:l},p=y(this);p&&(u.dangerReason=p);const _=e.defaultStrategyAlertMessage;return _&&(u.defaultStrategyAlertMessage=(0,c.clean)(_,!0)),u}idForAlert(){return this._collectDepsForAlert().idForAlert}hasBarColorer(){return(0,o.ensureNotNull)(this._metaInfo).plots.some(B.isBarColorerPlot)}barColorer(){const e=this._metaInfo.plots;let t=null;for(let s=0;s<e.length;++s)if((0,B.isBarColorerPlot)(e[s])){const e=new Lt(this,s);null===t?t=e:t.pushBackBarColorer(e)}return t}isSavedInStudyTemplates(){return this._metaInfo.inputs.every((e=>"bar_time"!==e.type))}restart(e){this._restarting=!0,this.clearData(),(e||ye.enabled("stop_study_on_restart"))&&this.stop(),setTimeout(this.start.bind(this),0)}stop(e,t){if(!0===e&&this._children)for(const e of this._children)e.stop(!0);this._stopStudyOnServer(),this.clearData(),this._unsubscribeToSessionId(),this.recalculate()}disconnect(){this._studyId=null,
this._model.isSnapshot()||(this._resolvedSymbols={},this._resolvedSymbolsByInput={})}sourceId(){return this._studyId}parentSources(){return this._sources}symbolSource(){return this._firstSourceOrSeries().symbolSource()}valueAt(e,t){return this.symbolSource().valueAt(e,t)}barsProvider(){return this._firstSourceOrSeries().barsProvider()}ownerSource(){return this.isChildStudy()?this._sources[0]:super.ownerSource()}isChildStudy(){return this._sources.length>0}hasChildren(){return this._children.length>0}isStarted(){return Boolean(this._studyId)}isRestarting(){return this._restarting}isActualInterval(){return this._isActualInterval}onIsActualIntervalChange(){return this._onIsActualIntervalChange}isVisible(){const e=this._properties.childs();if(this._model.collapsed().value()||!e.visible.value()||!this.isActualInterval())return!1;const t=this.metaInfo();if(t.plots.length>0)for(let s=0;s<t.plots.length;s++){const i=t.plots[s].id,r=e.styles.childs()[i];if(void 0===r)continue;if(0!==r.childs().display.value())return!0}if(t.bands)for(let s=0;s<t.bands.length;s++)if(e.bands.childs()[s].childs().visible.value())return!0;for(const s of Object.keys(t.graphics))for(const i of Object.keys(t.graphics[s])){const t=e.graphics.childs()[s]?.childs()[i];if(void 0!==t&&(t.child("visible")?.value()??1))return!0}if(t.filledAreas)for(let s=0;s<t.filledAreas.length;s++)if(e.filledAreasStyle.childs()[t.filledAreas[s].id].childs().visible.value())return!0;return!(!t.isTVScriptStrategy&&!t.hasAlertFunction)}async start(e,t,s){const i=this._model.mainSeries();await i.seriesCreated(),await Promise.all(this._sources.filter((e=>e.isHibernated())).map((e=>e.start())));const r=!(this.isHibernationAllowed()&&!this.isVisible())||!0===t;if(this._chartApi&&this._chartApi.isConnected().value()&&r)try{await this._allSymbolsAreResolved(),await this._startAfterSymbolsResolved(e,t)}catch(e){const t=`ERROR: ${this._debugId()} start failed, ${e}`;qt.logError(t),this._restarting=!1,"TooManyStudies"===e?.cause&&(0,I.showTooManyStudiesNotice)(this._chartApi.getStudyCounter())}}replaceData(e,t,s){this._invalidateLastNonEmptyPlotRowCache(),this.data().remove(e+1),this.data().addTail(s,t)}inputs(e){const t=(0,n.default)((0,W.clone)(Jt),e||{});t.skipOptionalEmptySymbolInputs&&(t.keepOptionalSymbolsEmpty=!0);const s=(0,r.default)(this._buildInputs(t));return t.patchSosInputs&&D.StudyMetaInfo.patchSoSInputs(s,(e=>this._sources.find((t=>t.id()===e))?.sourceId()??null)),s}data(){return this._data}moveData(e){this._ongoingDataUpdate=this._ongoingDataUpdate.then((()=>{this._invalidateLastNonEmptyPlotRowCache(),this.data().move(e)}))}plots(){return this.data()}metaInfo(){return this._metaInfo}status(){return this._compileActiveStatus??this._compileErrorStatus??this._status}name(e){return e?this.metaInfo().shortDescription||"Study":this.metaInfo().description||"Study"}title(e,t,s,i,r,n){i=void 0===i?!this._showStudyArgumentsProperty.value():i;const o=JSON.stringify([e,t,s,i,r,n]);if(this._titleStrCache[o])return this._titleStrCache[o]
;if(this._titleInPartsCache[o])return this._joinTitlesParts(this._titleInPartsCache[o]);const a=this._title(e,t,s,i,r,n);return this._titleStrCache[o]=a,a}titleInParts(e,t,s,i,r){i=void 0===i?!this._showStudyArgumentsProperty.value():i;const n=JSON.stringify([e,t,s,i,r]);if(this._titleInPartsCache[n])return this._titleInPartsCache[n];const o=this._titleInParts(e,t,s,i,r);return this._titleInPartsCache[n]=o,o}invalidateTitleCache(e){if(this._titleStrCache={},this._titleInPartsCache={},!0===e&&this._children)for(let t=0;t<this._children.length;++t)this._children[t].invalidateTitleCache(e)}graphics(){return this._graphics}graphicsInfo(){return this._metaInfo.graphics}priceLabelText(e){const t=this._metaInfo.styles,s=this._metaInfo.ohlcPlots;let i;t&&t[e]&&(i=t[e]),s&&s[e]&&(i=s[e]);const r=(0,o.ensureDefined)(i).title;return 1!==this._simplePlotsCount||(0,B.isPlotTitleDefined)(r)?this._metaInfo.is_price_study&&r!==this._metaInfo.shortDescription?""===r?this._metaInfo.shortDescription:this._metaInfo.shortDescription+":"+r:r:this._metaInfo.shortDescription}setOwnFirstValue(e){this._ownFirstValue=e}firstValue(e,t){if(t)return this._series.firstValue();if(!this.isChildStudy()&&"Compare@tv-basicstudies"===this._metaInfo.id||!this._metaInfo.is_price_study){const t=this._model.timeScale().visibleBarsStrictRange();if(null===t)return null;const s=this.properties().childs();if(!s.visible.value()||!this.isActualInterval()||null!==this._startMovingPoint)return this._ownFirstValue;const i=t.firstBar(),r=t.lastBar();let n=this._graphicsPriceRangeGroups?function(e,t){const s=e.model().timeScale();if(s.isEmpty())return null;const i=s.visibleBarsStrictRange();if(null===i)return null;const r=i.firstBar(),n=i.lastBar(),o=new ae;for(const e of t){const t=e.firstValue(r,n);o.improve(t)}return o.bestPrice()}(this,this._graphicsPriceRangeGroups):null;const a=(this._metaInfo.plots||[]).filter((e=>!this._metaInfo.isPlotForceOverlay(e.id)));if(null===n){const t=new Set,l=this._metaInfo.filledAreas||[];for(let e=0;e<l.length;e++){const i=l[e];s.filledAreasStyle.childs()[i.id].childs().visible.value()&&(t.add(i.objAId),t.add(i.objBId))}for(const l of this.data().rangeIterator(i,r)){const i=l.value;for(let r=0;r<a.length;++r){if((0,B.isColorerPlot)(a[r]))continue;const l=i[r+1];if(null==l)continue;const h=a[r].id;if((0!==(0,o.ensureDefined)(s.styles.childs()[h]).childs().display.value()||t.has(h))&&!(e&&Math.abs(l)<1e-10)){n=l;break}}if(null!==n)break}}return this._ownFirstValue=n,null!==n?n:this._bandsFirstValue(e)}if(this.isChildStudy()){const e=this._getNonPriceParent();if(e&&this.priceScale()===e.priceScale())return null!==e._ownFirstValue?e._ownFirstValue:e.firstValue()}return this._series.firstValue()}desiredPriceScalePosition(){if(this.metaInfo().isTVScriptStub)return"overlay";if(this.metaInfo().linkedToSeries)return"as-series";switch(this.metaInfo().priceScale){case 1:return"left";case 0:return"right";case 2:return"overlay";default:return null}}offset(e){let t=0;this._plotOffsets&&void 0!==this._plotOffsets[e]&&(t+=this._plotOffsets[e])
;const s=this.properties().childs(),i=s.offsets?.childs()[e];return i&&(t+=i.childs().val.value()),s.offset&&(t+=s.offset.childs().val.value()),t}tags(){return!this._metaInfo||!this._metaInfo.description||this._metaInfo.isTVScriptStub||this._metaInfo.is_hidden_study||this._metaInfo.isTVScript&&"tv-scripting"===this._metaInfo.productId?[]:[this._metaInfo.description]}copiable(){return es&&!this.isChildStudy()}setPriceScale(e){super.setPriceScale(e),(0,Ht.emit)("study_event",this.id(),"price_scale_changed")}priceRange(e,t,s){let i=null;const r=this._metaInfo,n=this._fillPrecalculatedAutoscaleInfo(e,t,s);let a=this.data().minMaxOnRangeCached(e,t,n.fields);if(a=(0,M.mergeMinMax)(n.baseValueMinMax,a),n.useMainSeriesRange){const s=[{name:"low",offset:0},{name:"high",offset:0}],i=this.series().data().bars().minMaxOnRangeCached(e,t,s);a=(0,M.mergeMinMax)(a,i)}if(null!==a&&(i=new R.PriceRange(a.min,a.max)),r.bands&&s.targetPriceScale===this.priceScale())for(let e=0;e<r.bands.length;e++){const t=(0,o.ensureDefined)(this._properties.childs().bands.childs()[e]).childs();if(t.visible.value()){const e=t.value.value();if(!(0,W.isNumber)(e))continue;i?i.apply(e,e):i=new R.PriceRange(e,e)}}if(this._graphicsPriceRangeGroups){const r=this.priceScale()===this._series.priceScale()?void 0:this.priceScale()!==s.targetPriceScale,n=function(e,t,s,i){let r=null;for(const n of e){const e=n.groupPriceRange(t,s,i);null!==e&&(r=null===r?e:r.merge(e))}return r}(this._graphicsPriceRangeGroups,e,t,!!s.forceOverlayOnly||r);n&&(i=i?i.merge(n):n)}return this._postProcessPriceRange(i,s)}autoScaleInfo(e,t,s){const i=this.priceRange(e,t,s),r=this.priceScale()===this._series.priceScale()?void 0:this.priceScale()!==s.targetPriceScale,n=this._graphicsPriceRangeGroups?function(e,t,s,i){const r=re();for(const n of e){const e=n.groupPixelMargins(t,s,i);r.bottomPixelMargin=Math.max(r.bottomPixelMargin,e.bottomPixelMargin),r.topPixelMargin=Math.max(r.topPixelMargin,e.topPixelMargin)}return r}(this._graphicsPriceRangeGroups,e,t,!!s.forceOverlayOnly||r):{topPixelMargin:0,bottomPixelMargin:0};return{range:i,topPixelMargin:n.topPixelMargin,bottomPixelMargin:n.bottomPixelMargin}}formatter(e){return this._formatter??this._firstSourceOrSeries().formatter(!1)}defaultFormatter(){const e=this._firstSourceOrSeries();return this._defaultFormatter??e.defaultFormatter?.()??e.formatter()}plotFormatter(e){return this._plotFormatters.get(e)??this.formatter()}isMultiPaneAvailable(){return this._metaInfo.hasForceOverlayPlots()||(0,V.hasForceOverlayPrimitives)(this._metaInfo)}isMultiPaneEnabled(){return this._metaInfo.hasForceOverlayPlots()}updateAllViews(e){const t=this._model.paneForSource(this),s=this._model.mainPane(),i="viewport-change"===e.type&&e.pane&&e.pane!==s;"viewport-change"===e.type&&e.pane&&e.pane!==t||(this._paneViews.forEach((t=>t.update(e))),this._labelPaneViews.forEach((t=>t.update(e))),this._dataWindowView?.update(),this._legendView?.update(),this._statusView?.update(),this._priceAxisViews.forEach((t=>t.update(e))),
this._priceLinesAxisViews.forEach((t=>t.update(e))),this._inputsLinesPaneView?.update(e),this._inputsAnchorsPaneView?.update(e),this._inputsTimeAxisPaneViews.forEach((t=>t.update(e))),this._inputsPriceAxisPaneViews.forEach((t=>t.update(e)))),i||(this._forceOverlaysPaneViews.forEach((t=>t.update(e))),this._forceOverlayLabelPaneViews.forEach((t=>t.update(e))),this._forceOverlayPriceAxisViews.forEach((t=>t.update(e)))),"data-source-change"===e.type&&e.sourceId===this.id()&&e.clearData&&this._children.forEach((e=>e.updateAllViews({type:"data-source-change",sourceId:e.id(),clearData:!0})))}removeByRemoveAllStudies(){return!0}getStudyName(){return this._studyName}nearestIndex(e,t,s){return this.data().search(e,t,s)?.index}getMinFirstBarIndexForPlot(e){const t=this._properties.childs(),s=this._metaInfo,i=t.styles.childs()[e]?.child("showLast")?.value()??t.filledAreasStyle.childs()[e]?.child("showLast")?.value()??s.styles?.[e]?.showLast??t.ohlcPlots.childs()[e]?.child("showLast")?.value()??s.ohlcPlots?.[e]?.showLast??null;if(null===i)return-1/0;const r=this.data().lastIndex();return null===r?-1/0:r-i+1}guiPlotName(e,t){return this._metaInfo.styles?.[t]?.title??this.title(e)}childStudyByRebind(){return this._childStudyByRebind}isPine(){return void 0!==this._metaInfo.pine}isStandardPine(){return this.isPine()&&D.StudyMetaInfo.isStandardPine(this._metaInfo.id)}isLinkedToSeries(){return!0===this._metaInfo.linkedToSeries}preferredZOrder(){return!1===this._metaInfo.behind_chart?0:null}defaultPlotIdForAlert(){return this._metaInfo.plots.length?this._metaInfo.plots[0].id:null}resolvedSymbolInfoBySymbol(e){return this._resolvedSymbols&&e&&this._resolvedSymbols[this._getSymbolForResolve(e)]||null}hasPendingUnresolvedSymbols(){return this._pendingResolveSymbols.size>0}hasSymbolInputs(){return this._metaInfo.inputs.some((e=>"symbol"===e.type))}currency(){const e=this.metaInfo();return Boolean(e)&&e.is_price_study?this._firstSourceOrSeries().currency():null}currencySourceSymbolInfo(){return this._currencySourceSymbolInfo??this.symbolSource()?.symbolInfo()??null}unit(){const e=this.metaInfo();return Boolean(e)&&e.is_price_study?this._firstSourceOrSeries().unit():null}canOverrideMinTick(){return!1}dataWindowView(){return this._dataWindowView}statusView(){return this._statusView}legendView(){return this._legendView}pineSourceCodeModel(){return this.metaInfo().pine?(this._pineSourceCodeModel||(this._pineSourceCodeModel=new P.AsyncResourceWrapper(Promise.all([s.e(98410),s.e(58722),s.e(83660),s.e(74588),s.e(83005),s.e(89199)]).then(s.bind(s,38447)).then((e=>this._isDestroyed?null:new e.PineSourceCodeModel(this))))),this._pineSourceCodeModel.promise()):Promise.resolve(null)}inputsForAlertState(){return this.inputs()}sessionId(){return this._firstSourceOrSeries().sessionId()}sessionIdChanged(){return this._firstSourceOrSeries().sessionIdChanged()}getSymbolString(e){return""===e?"":(0,U.encodeExtendedSymbolOrGetSimpleSymbolString)(this._getSymbolObject(e))}onStatusChanged(){return this._statusChanged}symbolsResolved(){return this._symbolsResolved
}onHibernationStateChange(){return this._onHibernationStateChange}legendValuesProvider(){return new k.StudyLegendValuesProvider(this,this.model())}statusProvider(e){return new j.StudyStatusProvider(this)}correctScaleMargins(e){if("Volume"===this.metaInfo().shortId){const t=this.model().paneForSource(this);return null!==t&&t.isOverlay(this)&&t.containsMainSeries()?{top:.75,bottom:0}:{top:e.top,bottom:0}}return e}canBeHiddenByGlobalFlag(){return!0}isSourceHidden(){return!this.isVisible()||this.canBeHiddenByGlobalFlag()&&L.hideAllIndicators().value()}wasCompletedBefore(){return this._wasCompletedBefore}paneViews(e){const t=this._model.mainPane();if(this.isSourceHidden())return null;if(!e.hasPriceDataSource(this))return e!==t?null:this._forceOverlaysPaneViews;const s=[];return!this._startMovingPoint&&this._wasCompletedBefore&&s.push(...this._paneViews.filter((e=>!e.isForceOverlay?.()))),this._inputsLinesPaneView&&(this._startMovingPoint||this._model.selection().isSelected(this))&&s.push(this._inputsLinesPaneView),this._inputsAnchorsPaneView&&s.push(this._inputsAnchorsPaneView),e===t&&s.push(...this._forceOverlaysPaneViews),s}labelPaneViews(e){const t=this._model.mainPane();if(this.isSourceHidden()||!e.hasPriceDataSource(this))return this._metaInfo.hasForceOverlayPlots()?e!==t?null:this._forceOverlayLabelPaneViews:null;const s=[...this._labelPaneViews];return e===t&&s.push(...this._forceOverlayLabelPaneViews),s}timeAxisViews(){return this._model.selection().isSelected(this)?this._inputsTimeAxisPaneViews:null}priceAxisViews(e,t){if(t!==this.priceScale()&&t===this._model.mainSeries().priceScale()&&!e.hasDataSource(this))return this._forceOverlayPriceAxisViews;const s=this._properties.childs().oldShowLastValue;if(s&&!s.value())return null;let i=this._priceAxisViews.slice();return this._model.selection().isSelected(this)&&(i=i.concat(this._inputsPriceAxisPaneViews)),t===this._model.mainSeries().priceScale()&&(i=i.concat(this._forceOverlayPriceAxisViews)),e.findTargetPriceAxisViews(this,t,i,this._priceLinesAxisViews)}movable(){return null!==this._inputsAnchorsPaneView}startMoving(e,t,s,i){this._startMovingPoint=e}move(e,t,s,i){if(void 0!==e.logical&&null!==this._startMovingPoint){if(Array.isArray(t)){const s=t;this._updateInputValue(e.logical,s[0]),this._updateInputValue(e.logical,s[1])}else this._updateInputValue(e.logical,t);this.updateAllViews((0,Dt.sourceChangeEvent)(this.id()))}}endMoving(e,t){return this._startMovingPoint=null,{indexesChanged:!1,pricesChanged:!1}}clearData(){this._invalidateLastNonEmptyPlotRowCache(),this.data().clear(),this._graphics instanceof T.LiveStudyGraphics&&this._graphics?.clear(),this._plotOffsets={},this.hasBarColorer()&&this._model.mainSeries().invalidateBarStylesCache(),this.updateAllViews((0,Dt.sourceChangeEvent)({sourceId:this.id(),clearData:!0}))}convertYCoordinateToPriceForMoving(e,t){const s=this.priceScale();if(!t||!s||s.isEmpty())return null;const i=t.firstValue();return null===i?null:s.coordinateToPrice(e,i)}processHibernate(e){const t=this.isVisible()
;if(!this.isStarted()&&t&&(this._sources.forEach((e=>{e.processHibernate()})),this.start(void 0,void 0,e),this._onHibernationStateChange.fire(!1)),this.isHibernationAllowed()&&this.isStarted()&&!t){for(const e of this._children)e.processHibernate();this.stop(void 0,e),this._onHibernationStateChange.fire(!0)}}isHibernationAllowed(){return!this.metaInfo().historyCalculationMayChange&&(!this.hasChildren()||!!this._model.collapsed().value()&&this._children.every((e=>e.isHibernationAllowed())))}isPlotVisibleAt(e,t){let s;const i=this.metaInfo().plots.find((t=>t.id===e));if(s=void 0!==i?(0,B.isOhlcPlot)(i)?this._properties.childs().ohlcPlots.childs()[i.target]:this._properties.childs().styles.childs()[e]:this._properties.childs().ohlcPlots.childs()[e],void 0===s)throw new Error(`Study does not contain ${e} plot`);const r=s.childs().display.value();return null!==r&&(r&t)===t}recalculate(){const e=this._model.paneForSource(this);this._model.recalculatePane(e,(0,Dt.sourceChangeEvent)(this.id())),this._model.updateSource(this)}maxOffset(){return this._maxOffset}onStart(){return this._onStart}onParentSourcesChanges(){return this._onParentSourcesChanges}isHibernated(){return!this.isVisible()&&!this.isStarted()}graphicsViewsReady(){return this._graphicsViewsReady}setLoadingCompilationActive(e){this._compileActiveStatus=e?{type:At.StudyStatusType.Loading,startTime:Date.now()}:null,this._statusView?.update(),this._model.updateSource(this),this._statusChanged.fire(this.status())}setErrorCompilation(e){{const t=(0,he.extractPineId)(this._metaInfo.id);if(null===e||0===e.length||null===t)return this._compileErrorStatus=null,void this._setStatus({type:At.StudyStatusType.Undefined});const s=e[0];this._compileErrorStatus={type:At.StudyStatusType.Error,errorDescription:{error:s.message,editorError:{...s,id:t},title:"Compilation error"}},this._statusView?.update(),this._model.updateSource(this),this._statusChanged.fire(this.status())}}hasCompileError(){return null!==this._compileErrorStatus}turnaround(e){if(!e)return this._turnaround;return function(e,t){let s=t.turnaround,i=[t];for(;i.length>0;){let e=[];const t=[];i.forEach((s=>{const i=fe(s.sourceStudies).sort(_e);if(i.length>0){e=e.concat(i);const s=i.map((e=>e.turnaround)).join("_");t.push(s)}})),t.length&&(s=t.join("_")+"_"+s),i=e}return e+"_"+s}(this._series.seriesSource().turnaround(),me(this))}canHaveChildren(){return this._canHaveChildren=this._canHaveChildren??D.StudyMetaInfo.canHaveChildren(this._metaInfo),this._canHaveChildren}setChild(e){-1===this._children.indexOf(e)&&this._children.push(e)}unsetChild(e){const t=this._children.indexOf(e);~t&&this._children.splice(t,1)}getAllChildren(){const e=this._children.slice();for(let t=0;t<e.length;++t){const s=e[t].getAllChildren();for(let t=0;t<s.length;++t)~e.indexOf(s[t])||e.push(s[t])}return e}parentSourceForInput(e){if(e.includes("$")){const t=e.split("$")[0];return this._sources.find((e=>e.id()===t))??null}return this._series}priceStep(){return this._priceStep||this._firstSourceOrSeries().priceStep(!1)}recreatePriceFormatter(){
this._recreatePriceFormattingDependencies()}setOwnerSource(e){super.setOwnerSource(e),this._recreatePriceFormattingDependencies()}onTagsChanged(){return this._tagsChanged}getPropertyDefinitionsViewModel(){return null===this._definitionsViewModel?this._getPropertyDefinitionsViewModelClass().then((e=>null===e||this._isDestroyed?null:(null===this._definitionsViewModel&&(this._definitionsViewModel=new e(this._model.undoModel(),this)),this._definitionsViewModel))):Promise.resolve(this._definitionsViewModel)}calculationTime(){return this._calculationTime.readonly()}_getPropertyDefinitionsViewModelClass(){return Promise.resolve(null)}_alertMetaInfo(){return this.metaInfo()}_createStudyOnServer(){if(this._isDestroyed)return!1;const e=this._metaInfo.useVersionFromMetaInfo?(0,D.getStudyIdWithVersion)(this._metaInfo):this._getStudyIdWithLatestVersion();this._studyId=(0,z.makeNextStudyId)(),this._incrementTurnaround(),this._studyName=e;const t=(0,W.clone)((0,o.ensureDefined)(this._inputs));let s;if(D.StudyMetaInfo.patchSoSInputs(t,(e=>this._sources.find((t=>t.id()===e))?.sourceId()??null)),s=this._chartApi.createStudy(this._studyId,this._turnaround,(0,o.ensureNotNull)(this._series.seriesSource().instanceId()),this._studyName,t,this._handler,this._studySpec()),!s)return this._studyId=null,s;if(performance.mark(`calculate_study_${this._studyId}`),void 0===this._oldStudyInputs){if(this._metaInfo.TVScriptMetaInfoExprs){this._previousPatchMap={};const e=this._metaInfo.TVScriptMetaInfoExprs.patchMap;(0,S.iterateAndPatchObjectsByMap)([this._properties,this._metaInfo.defaults,this._metaInfo],e,((e,t,s)=>{const i=e[0],r=e[1],n=e[2];r.hasOwnProperty(t)?(0,o.ensureDefined)(this._previousPatchMap)[s]=i[t].value():(0,o.ensureDefined)(this._previousPatchMap)[s]=n[t]}))}const e=this._prepareInputs(Zt);Object.keys(e).some((e=>(0,_.isStudyInputDependsOnChart)({id:e})))||(this._oldStudyInputs=e)}return this._deferredPinePatchProps&&!this._restarting&&this._pinePatchProps(),!0}_stopStudyOnServer(){this._chartApi&&this._chartApi.isConnected().value()&&this.isStarted()&&(this._chartApi.removeStudy((0,o.ensureNotNull)(this._studyId)),this._setStatus({type:At.StudyStatusType.Undefined})),performance.clearMarks(`calculate_study_${this._studyId}`),this._studyId=null}_modifyStudyOnServer(e,t){const s=(0,W.clone)((0,o.ensureDefined)(e));D.StudyMetaInfo.patchSoSInputs(s,(e=>this._sources.find((t=>t.id()===e))?.sourceId()??null)),this._chartApi.modifyStudy((0,o.ensureNotNull)(this._studyId),this._turnaround,s,this._handler,t),performance.mark(`calculate_study_${this._studyId}`)}_sendNotifyCommand(e,t){this._chartApi.notifyStudy((0,o.ensureNotNull)(this._studyId),e,t)}_transformData(e){}_invalidateLastNonEmptyPlotRowCache(){this._lastNonEmptyPlotRowCache={}}_collectDepsForAlert(){const e=[this,...this._getAllOwnerSources().filter((e=>e instanceof us))];return(0,g.collectDepsForAlert)(e)}_allInputsAreValid(){if(null===this._visibleTimeRangeInputs?.value())return!1;for(const e of this._metaInfo.inputs)if("bar_time"===e.type){const t=e.id
;if(null==this._properties.childs().inputs.childs()[t].value())return!1}return!0}async _startAfterSymbolsResolved(e,t){await Promise.all(this._sources.map((e=>!e.isStarted()||e.isRestarting()?new Promise((t=>{e.onStart().subscribe(this,t,!0)})):Promise.resolve()))),this.isStarted()&&!this._restarting||(this._restarting=!1,this._allInputsAreValid()&&!this.metaInfo().isTVScriptStub&&(this._inputs=this._apiInputs(),this._createStudyOnServer()&&(this._subscribeToSessionId(),this._onStart.fire(),!0===e&&this._children&&await this._children.map((e=>e.start(!0,t))))))}async _changeInputsImpl(e,t){const i=this._calcSources(),r=os(this._metaInfo,e,t),n=()=>{for(const s of this._metaInfo.inputs){if("source"!==s.type)continue;const i=e[s.id].v,r=t[s.id].v;if(i!==r){(0,o.ensureDefined)(this._properties.childs().inputs.child(s.id)).setValue(r)}}};if(this.isStarted()&&this._chartApi.isConnected().value()&&r>0&&!this._chartApi.canCreateStudy(this._studySpec(!0),!0).success){const e=window.user.pro_plan;return(0,b.createGoProDialog)({feature:"studyOnStudy",actions:e&&"pro_premium_expert"===e?[{text:a.t(null,void 0,s(515462)),action:v.PredefinedAction.Close}]:void 0}),void n()}this._inputs=e;let l=!1;const h=Object.values(_.RangeDependentStudyInputNames);for(const s of Object.keys(e))if(JSON.stringify(e[s])!==JSON.stringify(t[s])&&!h.includes(s)){l=!0;break}this._incrementTurnaround(),l&&this.disablePriceRangeReady();try{await this._updateParentSources(i,r,!0),this._modifyStudyOnServer(e,r),this._studyModified=!0}catch(e){qt.logError(`Error applying parent sources: ${e}`),n()}this.invalidateTitleCache()}_createPriceAxisView(e){return new kt.StudyPriceAxisView(this,{plotIndex:e})}_createPriceLineAxisView(e){return new Bt.StudyPriceLineAxisView(this,e)}_createStudyPlotPaneView(e){return new dt.StudyPlotPaneView(this,this._series,this._model,e)}_createViews(){this._priceAxisViewsBase=[],this._forceOverlayPriceAxisViews=[],this._priceLinesAxisViews=[],this._paneViews=[],this._forceOverlaysPaneViews=[],this._labelPaneViews=[],this._forceOverlayLabelPaneViews=[];const e=new Set,t=this.metaInfo(),s=Boolean(t.usePlotsZOrder),i=new Map,r=this._properties.childs();if(r.filledAreasStyle&&t.filledAreas)for(let e=0;e<t.filledAreas.length;++e){const n=t.filledAreas[e],a=(0,o.ensureDefined)(r.filledAreasStyle.childs()[n.id]),l=ns(t,n.id);let h;if("plot_plot"===n.type||l?h=new bt(this,this.model(),n,a):"hline_hline"===n.type?h=new xt(this,n,a):qt.logWarn("Unsupported filledArea type: "+n.type),void 0!==h){let e=!1;if("plot_plot"===n.type&&(e=t.isPlotForceOverlay(n.objAId)),e)this._forceOverlaysPaneViews.push(h);else{const e=s?(0,o.ensureDefined)(n.zorder):i.size;rs(e,i),i.set(e,{paneViews:[h]})}}}{let r=-1e5;for(let n=0;n<t.plots.length;n++){const a=t.plots[n];let l,h,c,u,d,p=t.isPlotForceOverlay(a.id);if((0,B.isNonVisualPlot)(a))continue;let _=a.id,f=t.styles;const m=(0,B.isBgColorerPlot)(a);if(m)l=new Pe(this,this._series,this._model,_);else if((0,B.isShapesPlot)(a))l=new ze(this,this._series,this._model,_);else if((0,
B.isCharsPlot)(a))l=new Xe(this,this._series,this._model,_);else if((0,B.isArrowsPlot)(a))l=new nt(this,this._series,this._model,_);else if((0,B.isOhlcPlot)(a)){const s=a.target;if(e.has(s))continue;if(p=t.isPlotForceOverlay(s),e.add(s),ss(t,n))l=new lt(this,this._series,this._model,s);else{if(!is(t,n)){qt.logError(`plot ${a.id} looks to be invalid`);continue}l=new ct(this,this._series,this._model,s)}u=this._createPriceAxisView(s),c=new ut.PanePriceAxisView(u,this,this._model),_=s,f=t.ohlcPlots}else(0,B.isDataPlot)(a)||(u=this._createPriceAxisView(_),d=this._createPriceLineAxisView(_),l=this._createStudyPlotPaneView(_),this._properties.childs().styles.childs()[_]?.child("trackPrice")?.value()&&(h=new ft(this,_)),c=new jt(u,this,this._model,_));const y=s?m?r++:(0,o.ensureDefined)(f?.[_]?.zorder):i.size;if(rs(y,i),p)u&&this._forceOverlayPriceAxisViews.push(u),l&&this._forceOverlaysPaneViews.push(l),c&&this._forceOverlayLabelPaneViews.push(c);else{const e={paneViews:void 0!==l?[l]:[],labelView:c,priceAxisView:u,priceLineAxisView:d};void 0!==h&&e.paneViews.push(h),i.set(y,e)}}}(this._metaInfo.bands??[]).forEach(((e,t)=>{const n=r.bands.childs()[t];if(n&&n.childs().visible.value()){const t=new Pt(n,this),r=s?(0,o.ensureDefined)(e.zorder):i.size;rs(r,i),i.set(r,{paneViews:[t]})}})),r.bandsBackground&&((0,o.assert)(!s,"'usePlotsZOrder' flag does not supported"),i.set(i.size,{paneViews:[new Vt(this)]}));const n=this._paneViews,a=this._forceOverlaysPaneViews;this._createGraphicsPaneViews().then((e=>{for(let t=0;t<e.regularPaneViews.length;t++)n.push(e.regularPaneViews[t]);for(let t=0;t<e.forceOverlayPaneViews.length;t++)a.push(e.forceOverlayPaneViews[t]);this._model.lightUpdate(),this._graphicsViewsReady=!0})),r.areaBackground&&((0,o.assert)(!s,"'usePlotsZOrder' flag does not supported"),i.set(i.size,{paneViews:[new mt.AreaBackgroundPaneView(this,this.model())]}));const l=Array.from(i.keys()).sort(((e,t)=>e-t));for(let e=0;e<l.length;e++){const t=(0,o.ensureDefined)(i.get(l[e]));this._paneViews.push(...t.paneViews),t.labelView&&this._labelPaneViews.push(t.labelView),t.priceAxisView&&this._priceAxisViewsBase.push(t.priceAxisView),t.priceLineAxisView&&this._priceLinesAxisViews.push(t.priceLineAxisView)}this._dataWindowView||(this._dataWindowView=new vt.StudyDataWindowView(this,this._model)),this._legendView||(this._legendView=new E(this,this._model)),this._statusView||(this._statusView=new H.StudyStatusView(this)),this._concatPriceAxisViews()}_onData(e){switch(e.method){case"study_loading":this._onStudyLoading();break;case"study_error":this._onStudyError(e.params[2]);break;case"study_completed":if(!this._checkTurnaround(e.params[1]))return;this._onStudyCompleted(e.params[e.params.length-1]);break;case"data_update":if(e.params.customId!==this.sourceId()||!this._checkTurnaround(e.params.turnaround))return;(0,o.assert)(!!e.params.nonseries,"data.params.nonseries is missing"),this._onDataUpdate(e.params.plots,(0,o.ensureDefined)(e.params.nonseries),e.params.lastBar);break;case"clear_data":
this._checkTurnaround(e.params.turnaround)&&this.clearData()}}_getTelemetryObjectName(){return"study"}_onDataUpdated(e,t,s,i){if(this.hasBarColorer()&&e.length>0){const t=(0,o.ensureNotNull)(this.barColorer()).firstColoredBar(e[0].index);null!==t&&this._model.mainSeries().invalidateBarStylesCache(t)}null!==t&&this._postProcessGraphics();const r=this._model.paneForSource(this);this._model.recalculatePane(r,(0,Dt.sourceChangeEvent)({sourceId:this.id(),firstUpdatedTimePointIndex:i??void 0,nonSeriesOnly:0===e.length})),this._updateSources()}_titleInputs(e,t,s){return this.inputs(this._titleInputsOptions(e,t,s))}_titleInputsOptions(e,t,s){return{symbolsForDisplay:!0,skipHiddenInputs:!0,skipFakeInputs:!1,fakeInputsForDisplay:!0,asObject:!0,skippedGroups:[],skippedInputs:this._skippedTitleInputs(),noExchanges:t,noResolution:s,priceInputsForDisplay:!0,skipOptionalEmptySymbolInputs:Qt,displayMask:e}}_postProcessGraphics(){this._graphicsPriceAxisViews=this._createGraphicsPriceAxisViews(),this._concatPriceAxisViews()}async _createGraphicsPaneViews(){return(0,T.createGraphicsPaneViews)(this,this.model())}_createGraphicsPriceAxisViews(){return(0,T.createGraphicsPriceAxisViews)(this)}_subscribeToSessionId(){!this._isSubscribedToSessionId&&this.hasSymbolInputs()&&(this.sessionIdChanged().subscribe(this,this._onSessionIdChanged),this._isSubscribedToSessionId=!0)}_recreateFormatter(e){this._recreatePlotsFormatters(e),this._formatter=this._tryCreateFormatter(e),this._defaultFormatter=this._tryCreateDefaultFormatter(e),this._formatterChanged.fire();const t=this.priceScale();null!==t&&t.updateFormatter(),this.getAllChildren().forEach((e=>{e.recreatePriceFormatter()})),this._model.fullUpdate()}_recreatePriceFormattingDependencies(e){this._recreateFormatter(e),this._recreatePriceStep()}_title(e,t,s,i,r,n){const o=this._titleInParts(e,t,s,i,r,n);return this._joinTitlesParts(o)}_postProcessPriceRange(e,t){if(e&&e.minValue()===e.maxValue()&&!this.metaInfo().is_price_study){const t=.005*e.minValue();e=new R.PriceRange(e.minValue()-t,e.maxValue()+t)}const s=t.targetPriceScale;return s&&s.isLog()&&e?new R.PriceRange(s.priceToLogical(e.minValue()),s.priceToLogical(e.maxValue())):e}_titleInParts(e,t,i,r,n,l){const h=this.name(t);i=i||{};const c=[a.t(h,{context:"study"},s(783477))];let u=[];if(!r){const s=this._getMTFResolutionInputTitle();null!==s&&s.length>0&&c.push(s);const r=this.metaInfo(),a=this._titleInputs((0,Kt.toInputDisplayFlags)(e),n,!0),h=r.inputs.filter((e=>a.hasOwnProperty(e.id))).map((e=>({meta:e,value:a[e.id]})));if(h.length>0){const s={};if(this.isChildStudy())for(let i=0;i<r.inputs.length;++i){const a=r.inputs[i];if(!D.StudyMetaInfo.isSourceInput(a))continue;const h=a.id,c=(0,o.ensureDefined)(this._properties.childs().inputs.child(h)).value();if(c.indexOf("$")>=0){const i=this.parentSourceForInput(c);if(i instanceof us){const r=i.metaInfo(),o=i.title(e,t,{},!0,n,l);if(1===r.plots.length)s[c]=o;else{const e=c.split("$")[1],t=r.plots[parseInt(e)]?.id,i=r.styles&&r.styles[t],n=i&&i.title||t;s[c]=o+": "+n}}}}
u=h.map((({meta:e,value:t})=>{if("time"===e.type)return new Date(t).toISOString();let r=(0,W.isNumber)(t)?(0,Wt.getNumericFormatter)().format(t):s&&s[t.toString()]||t.toString();return i&&i[r.toString()]&&(r=i[r.toString()]),r}))}}return e===$.TitleDisplayTarget.StatusLine&&this._showPineVersionInStatusLine.value()&&c.push((0,o.ensureDefined)(this._metaInfo.pine).version),[c.join(" · "),u]}_seriesDataRangeToSave(e){return this._model.timeScale().visibleExtendedDataRange(e,0)}_getSymbolForResolve(e){return this.getSymbolString(this._getSymbolForApi(e))}_getSymbolForApi(e){return e}_getSymbolObject(e){const t={symbol:e},s=this.currency();return null!==this._currencySourceSymbolInputProperty&&null!==this._currencySourceSymbolInfo&&this._getSymbolForApi(this._currencySourceSymbolInputProperty.value())===e&&(t["currency-id"]=s),t.session=this.sessionId(),t}_onSymbolResolved(e,t,s){{const e=(0,o.ensureNotNull)(this._model.alertsWatcher());e.syncSourceAlertLabels(this);const t=this.getAllChildren();for(const s of t)e.syncSourceAlertLabels(s)}this._onCurrencyMayChange()}_onSymbolResolvingStart(e,t){}_onSymbolError(){}_setStatus(e,t){const s=this.isFailed();this._status=e,e.type===At.StudyStatusType.Completed?this._wasCompletedBefore=!0:e.type!==At.StudyStatusType.Error&&e.type!==At.StudyStatusType.Undefined||(this._wasCompletedBefore=!1),t||(this._statusView?.update(),this._model.updateSource(this),this._statusChanged.fire(this.status())),s!==this.isFailed()&&this._updateAlertCreationAvailable()}_onPropertiesChanged(){this._restarting||(this._inputs?this._tryChangeInputs():this._chartApi&&this._chartApi.isConnected().value()&&this.restart()),this._metaInfo.isTVScript&&this._metaInfo.TVScriptMetaInfoExprs&&(this._restarting?this._deferredPinePatchProps=!0:this._pinePatchProps()),this._recreatePaneViews(),(0,Ht.emit)("study_properties_changed",this._id.value())}_lastNonEmptyPlotRow(e){if(!(0,W.isInteger)(e))return qt.logDebug("_lastNonEmptyPlotRow: incorrect plotIndex"),null;let t=this._lastNonEmptyPlotRowCache[e]??null;if(null!==t)return t;return t=this.data().findLast(((t,s)=>void 0!==s[e]),1e3),null===t?null:(this._lastNonEmptyPlotRowCache[e]=t,t)}_onCurrencyChanged(){"alwaysOff"!==(0,Ft.currencyUnitVisibilityProperty)().value()&&this._model.fullUpdate(),this.isStarted()&&this._tryChangeInputs(),this._currencyChanged.fire()}_apiInputs(){return this.inputs({keepOptionalSymbolsEmpty:!0})}async _tryChangeInputs(){const e=this.isStarted()&&this._chartApi.isConnected().value(),t=this._allInputsAreValid(),s=(0,o.ensureDefined)((0,W.clone)(this._inputs)),i=this._apiInputs(),r=JSON.stringify(i),n=r!==JSON.stringify(this._inputs);if(e&&t)try{if(await this._allSymbolsAreResolved(),r!==JSON.stringify(this._apiInputs()))return this._tryChangeInputs();if(this._isStopped())return void(n&&this.disablePriceRangeReady());n&&(await this._changeInputsImpl(i,(0,o.ensureDefined)((0,W.clone)(this._inputs))),(0,o.ensureNotNull)(this.model().alertsWatcher()).syncSourceAlertLabels(this))}catch(e){
qt.logError(`ERROR: ${this._debugId()} _tryChangeInputs: cannot modify study, ${e}`)}else if(e&&!t&&this.stop(!0),!e&&t&&this.start(!0),n){const e=this._calcSources(),t=os(this._metaInfo,i,s);this._updateParentSources(e,t,!0),this._inputs=i}this._tagsChanged.fire()}_onCurrencyMayChange(){if(null!==this._currencySourceSymbolInputProperty){const e=this.currency();this._updateCurrencySourceSymbolInfo(),e!==this.currency()&&this._onCurrencyChanged()}}_fillPrecalculatedAutoscaleInfo(e,t,s){const i=this._metaInfo,r=this.properties().childs(),n=new Set,o=this._metaInfo.filledAreas||[];for(let e=0;e<o.length;e++){const t=o[e];r.filledAreasStyle.childs()[t.id].childs().visible.value()&&(n.add(t.objAId),n.add(t.objBId))}return i.plots.filter((e=>!(0,B.isPlotWithTechnicalValues)(e))).filter((e=>this._metaInfo.isPlotForceOverlay(e.id)?s.targetPriceScale===this._model.mainSeries().priceScale():s.targetPriceScale===this.priceScale()&&!s.forceOverlayOnly)).filter((e=>n.has(e.id)||this.isPlotVisibleAt(e.id,1))).reduce(((s,i)=>this._applyPlotToPrecalculatedAutoscaleInfo(e,t,s,i)),{fields:[],useMainSeriesRange:!1,baseValueMinMax:null})}_firstSourceOrSeries(){return this._sources[0]??this._series}_skipHistogramBaseOnAutoScale(){return!1}_tryCreateFormatter(e){const t=void 0===e?this.symbolSource().symbolInfo():e;return hs(this._metaInfo.format,this._priceScaleByProperties(),t,this.properties().childs().precision.value())}_tryCreateDefaultFormatter(e){return this._tryCreateFormatter(e)}_mergeData(e){return this._invalidateLastNonEmptyPlotRowCache(),this.data().merge(e)}_skippedTitleInputs(){return this._hideMatches.filter((e=>e.plotIds.every((e=>0===this._getPlotDisplayValue(e))))).map((e=>e.id))}_getPlotDisplayValue(e){return this.properties()?.childs()?.styles?.childs()?.[e]?.childs()?.display?.value()}_onStudyError(e){performance.clearMarks(`calculate_study_${this._studyId}`),this._handleStudyError(this._createStudyError(e)),this._enablePriceRangeReady()}_onStudyCompleted(e){if(performance.getEntriesByName(`calculate_study_${this._studyId}`).length){try{const e=performance.measure(`measure_study_${this._studyId}`,`calculate_study_${this._studyId}`);this._calculationTime.setValue(e.duration)}catch(e){qt.logError("Error during measuring study calculation time")}performance.clearMarks(`calculate_study_${this._studyId}`),performance.clearMeasures(`measure_study_${this._studyId}`)}this._studyModified&&(this.clearData(),this._studyModified=!1),this._sendTelemetryCounter(this._getTelemetryObjectName()+"_loaded"),this._setStatus({type:At.StudyStatusType.Completed}),this._statusView?.update();const t=this._model.paneForSource(this);this._model.recalculatePane(t,(0,Dt.sourceChangeEvent)(this.id())),this._updateSources();const s=Mt.InvalidationMask.full();null!==this._model.appliedTimeFrame().value()&&s.lockVisibleTimeRangeOnResize(),this._model.invalidate(s)}_incrementTurnaround(){this._turnaround="st"+ ++this._turnaroundCounter}_checkTurnaround(e){
return e===this._turnaround||e===this._model.mainSeries().seriesSource().turnaround()||e===this.turnaround(!0)}_updateMaxOffsetValue(){let e=-1/0;for(const t of this._metaInfo.plots)e=Math.max(this.offset(t.id),e);this._maxOffset.setValue(e)}_rightOffsetToUnixTime(e){if(this._series.bars().size()>=e){const t=(0,o.ensureNotNull)(this._series.bars().lastIndex())-e;return(0,o.ensureNotNull)(this._series.bars().valueAt(t))[0]}return null}_concatPriceAxisViews(){this._priceAxisViews=[...this._priceAxisViewsBase,...this._graphicsPriceAxisViews]}_onStudyLoading(){this._setStatus({type:At.StudyStatusType.Loading,startTime:Date.now()}),this._statusView?.update(),this._model.updateSource(this)}_handleStudyError(e){this.clearData(),this._setStatus(e);{const t=(0,At.convertStudyStatusToString)(e),s=this._getTelemetryAdditionalData(),i=t.indexOf("Command info");s.reason=i>=0?t.slice(0,i).trim():t;if(!/study in error state|the data vendor doesn\'t provide volume data for this symbol.|error in series|unsupported resolution/gi.test(s.reason?.toLowerCase()??"")){const e=this._getTelemetryObjectName();this._sendTelemetryCounter(e+"_error",s)}}this._statusView?.update(),this._model.updateSource(this)}_createStudyError(e){let t;return t=(0,W.isString)(e)?{error:this._getStudyErrorText(e),title:e.includes("study_not_auth")?"Access error":"Runtime error"}:{...e,title:e.title??"Runtime error"},(0,At.createStudyError)(t,this.symbolSource().symbolInfo()?.exchange)}_updateSources(){this._model.updateSource(this),this.hasBarColorer()&&this._model.updateSource(this._model.mainSeries())}_unsubscribeToSessionId(){this._isSubscribedToSessionId&&(this.sessionIdChanged().unsubscribe(this,this._onSessionIdChanged),this._isSubscribedToSessionId=!1)}_onSessionIdChanged(){this.restart(!0)}_recreatePriceStep(){let e=null;const t=this._priceScaleByProperties()??this._priceScaleByMetaInfo();null!==t&&(e=1/t),this._priceStep!==e&&(this._priceStep=e,this._priceStepChanged.fire())}_recreatePlotsFormatters(e){this._plotFormatters.clear();const t=this._metaInfo.format,s=this._priceScaleByProperties(),i=void 0===e?this.symbolSource().symbolInfo():e;for(const[e,r]of Object.entries(this._metaInfo.ohlcPlots??{}))if(r?.format){const n=hs(ls({...t,...r?.format}),s,i,this.properties().childs().precision.value());n&&this._plotFormatters.set(e,n)}for(const[e,r]of Object.entries(this._metaInfo.styles??{}))if(r?.format){const n=hs(ls({...t,...r?.format}),s,i,this.properties().childs().precision.value());n&&this._plotFormatters.set(e,n)}for(const e of this._metaInfo.plots)if((0,B.isOhlcPlot)(e)){const t=this._plotFormatters.get(e.target);t&&this._plotFormatters.set(e.id,t)}}_joinTitlesParts(e){const t=e[1]?e[1].join(", "):"";return e[0]+(t.length>0?" ("+t+")":"")}_getMTFResolutionInputTitle(){const e=this.metaInfo();for(let t=0;t<e.inputs.length;t++){const s=e.inputs[t];if("resolution"===s.type&&s.isMTFResolution)return(0,o.ensureDefined)(this._properties.childs().inputs.child(s.id)).value()}return null}_onDataUpdate(e,t,s){this._studyModified&&(this.clearData(),
this._studyModified=!1);const i=(0,x.unpackNonSeriesData)(t.d);return this._ongoingDataUpdate=this._ongoingDataUpdate.then((()=>i),(()=>i)).then(this._onDataUnpacked.bind(this,e,t.indexes,s)),this._ongoingDataUpdate}_allSymbolsAreResolved(){const e=this._inputSymbols(),t=[];let s=!1;for(const i of e){const e=this._getSymbolForResolve(i);if(""!==e)if(this._resolvedSymbols[e])s=!0;else{const s=this._resolveSymbol(e,i);t.push(s)}}if(0===t.length){const e=Promise.resolve();return s?e.then((()=>this._symbolsResolved.fire())):e}return Promise.all(t).catch((e=>(this._inputSymbols().includes(e)&&this.stop(!0),this._setStatus({type:At.StudyStatusType.Error,errorDescription:{error:Yt}}),this._model.updateSource(this),Promise.reject("Invalid symbol, "+e)))).then((()=>{this._symbolsResolved.fire(),this._recheckLineToolsActuality()}))}_resolveSymbol(e,t){if(""===e)return Promise.resolve();let s=this._pendingResolveSymbols.get(e);return void 0!==s||(s=new Promise(((s,i)=>{this._onSymbolResolvingStart(e,t),this._chartApi.resolveSymbol((0,z.makeNextSymbolId)(),e,(r=>{switch(this._pendingResolveSymbols.delete(e),r.method){case"symbol_resolved":{this._setStatus({type:At.StudyStatusType.Undefined});const i=r.params[1];this._resolvedSymbols[e]=i,this._resolvedSymbolsByInput[t]=i,this._onSymbolResolved(e,t,i),this.invalidateTitleCache(!0),s();break}case"symbol_error":if(this._setStatus({type:At.StudyStatusType.Error,errorDescription:{error:r.params[1]}}),this._onSymbolError(),r.params[1]===G.permissionDenied&&r.params[2]){if(r.params[2]!==G.SymbolErrorPermissionDeniedReason.Symbol)return void this._resolveSymbol(r.params[2],t).then(s);if(r.params[3])return void this._resolveSymbol(r.params[3],t).then(s)}this._sendTelemetryCounter("symbol_error",Object.assign(this._getTelemetryAdditionalData(),{symbol:e,reason:r.params[1]})),i(t)}}))})),this._pendingResolveSymbols.set(e,s)),s}_recheckLineToolsActuality(){const e=this._model.paneForSource(this);null!==e&&e.sourcesByGroup().lineSourcesForAllSymbols().forEach((e=>{e.ownerSource()===this&&e.calcIsActualSymbol()}))}_sendTelemetryCounter(e,t){void 0===t&&(t=this._getTelemetryAdditionalData());const s={count:1,additional:t};le.telemetry.sendChartReport(e,s)}_getTelemetryAdditionalData(){let e="";return this._metaInfo.pine&&this._metaInfo.pine.version&&this._metaInfo.shortId.indexOf("USER")>=0&&(e="_v"+this._metaInfo.pine.version),{symbol:this.series().actualSymbol(),resolution:this.series().interval(),study:this._metaInfo.shortId+e}}_onSourceFormatterChanged(){null===this._formatter&&(null!==this._priceScale&&this._priceScale.updateFormatter(),this._formatterChanged.fire())}_onSourcePriceStepChanged(){null===this._priceStep&&this._priceStepChanged.fire()}_bandsFirstValue(e){const t=this._metaInfo;if(!t.bands)return null;for(let s=0;s<t.bands.length;s++){const t=(0,o.ensureDefined)(this._properties.childs().bands).childs()[s];if(t.childs().visible.value()){const s=t.childs().value.value();if(e&&0===s)continue;return s}}return null}_prepareInputs(e){(0,o.assert)(!!e,"options not set")
;const t=this.metaInfo(),s={},i=e.allowedInputTypes?new Set(e.allowedInputTypes):null;for(let r=0;r<t.inputs.length;r++){const n=t.inputs[r];if(null!==i&&!i.has(n.type))continue;if(n.isFake&&e.skipFakeInputs)continue;if(n.isMTFResolution&&e.noResolution)continue;if(void 0!==e.displayMask&&!((0,o.ensureDefined)(n.display)&e.displayMask))continue;if(e.skipHiddenInputs&&(!e.doNotSkipHiddenWithMigrate||!n.migrate)){let t=!1;switch(n.type){case"bool":t=e.skipBooleanInputs;break;case"color":t=e.skipColorInputs;break;case"time":t=e.skipTimeInputs;break;case"text_area":t=e.skipTextareaInputs;break;default:t=Boolean(n.isHidden)}if(t)continue}if(void 0!==n.groupId&&-1!==e.skippedGroups.indexOf(n.groupId))continue;if(-1!==e.skippedInputs.indexOf(n.id))continue;const a=this._prepareInput(n,e);"symbol"===n.type&&e.skipOptionalEmptySymbolInputs&&""===a||(s[n.id]=(0,W.clone)(a))}return s}_prepareInputValue(e,t){const s=e.id,i=this._properties.childs();if(t.valuesAsIsFromProperties)return i.inputs.childs()[s].value();if("symbol"===e.type){const r=t&&t.symbolsForDisplay,n=i.inputs.childs()[s].value();let o=r?n:this._getSymbolForApi(n),a=this._resolvedSymbols?.[this._getSymbolForResolve(o)]??null;if(""===o&&e.optional){if(t&&t.keepOptionalSymbolsEmpty)return o;o=this._model.mainSeries().symbol(),a=this._model.mainSeries().symbolInfo()}if(r)if(a)if(Xt){switch(this._model.mainSeries().symbolTextSourceProxyProperty().value()){case"description":o=a.description;break;case"ticker-and-description":o=`${a.name}, ${a.description}`;break;case"ticker":o=a.name}}else o=(0,Nt.symbolTitle)(a,t.noExchanges);else ts&&(o="");else a&&(o=a.ticker||a.full_name),!this.isPine()&&t&&t.symbolsForChartApi&&(o=this.getSymbolString(o));return o}if("bar_time"===e.type){let e=i.inputs.childs()[s].value();if(e<0){const t=this._rightOffsetToUnixTime(-e);e=t&&t>=0?t:e}return e}if(this._metaInfo.isTVScript||this._metaInfo.pine){if("text"===s)return this._metaInfo.defaults.inputs?.text??"";if("pineId"===s)return this._metaInfo.scriptIdPart;if("pineVersion"===s)return this._metaInfo.pine?this._metaInfo.pine.version:"-1";if("color"===e.type&&this._metaInfo.isRGB){const e=i.inputs.childs()[s].value();return(0,C.colorToInteger)(e)}if("price"===e.type){const e=i.inputs.childs()[s].value();return t.priceInputsForDisplay?this.formatter().format(e):e}}return i.inputs.childs()[s].value()}_getAllOwnerSources(){return as(this).reverse().slice(1)}_getStudyIdWithLatestVersion(){return D.StudyMetaInfo.getStudyIdWithLatestVersion(this.metaInfo())}_debugId(){const e=[];return this._studyId&&e.push(this._studyId),e.push(this._metaInfo.fullId),e.push(this._metaInfo.description),JSON.stringify({study:e})}_hasAvailableAlertPlots(){if(null===this._alertMetaInfo())return!1;const e=this.stateForAlert(),t=u.alertBandFactory.create(e).getPlots();return null!=t&&t.length>0}_hasAlertConditions(){const e=this._alertMetaInfo();if(null===e)return!1;if(e.plots.some(B.isAlertConditionPlot))return!0;const t=this.stateForAlert();return Boolean(t.alerts&&t.alerts.conditions)}_hasAlertFunction(){
const e=this._alertMetaInfo();return Boolean(null!==e&&e.hasAlertFunction)}async _updateParentSources(e,t,s){if(this._sources.forEach((e=>e.unsetChild(this))),s&&await Promise.all(e.map((e=>e.isStarted()?Promise.resolve():e.start(!1,!0)))),e.forEach((e=>e.setChild(this))),this._setSources(e),this._recreatePriceFormattingDependencies(),0!==t&&this._sources.length<=1){const e=this._firstSourceOrSeries(),t=this._priceScale,s=(0,o.ensureNotNull)(e.priceScale());if(t!==s){const t=this._model.paneForSource(this),i=(0,o.ensureNotNull)(this._model.paneForSource(e));t===i&&i.move(this,s,!0)}}}_calcSources(){const e=this._properties.childs().inputs.state();return D.StudyMetaInfo.getSourceIdsByInputs(this._metaInfo.inputs,e).map((e=>{if("high"===e||"open"===e||"low"===e||"close"===e||"hl2"===e||"ohl3"===e||"ohlc4"===e)return null;return this._model.allStudies().find((t=>t.canHaveChildren()&&t.id()===e))??null})).filter(W.notNull)}_isStopped(){return!this.isStarted()}_onDataUnpacked(e,t,s,i){if(this._isDestroyed)return;"nochange"!==t&&this._processPlotOffsets(i),this._transformData(e);const r=this._mergeData(e);null!==i&&(i.indexes_replace?((0,o.assert)("nochange"!==t),this._graphics.replaceIndexesTo(t)):("nochange"!==t&&this._graphics.replaceIndexesTo(t),void 0!==i.graphicsCmds&&this._graphics.processCommands(i.graphicsCmds))),this._onDataUpdated(e,i,t,r&&r.index),this.priceRangeReady()||this._enablePriceRangeReady(),this._dataUpdated.fire(s,!1,r)}_processPlotOffsets(e){if(e&&e.indexes_replace)return;const t=this._plotOffsets;this._plotOffsets=e&&e.offsets||{},(0,i.default)(t,this._plotOffsets)||this.updateAllViews((0,Dt.sourceChangeEvent)({sourceId:this.id(),clearData:!0})),this._updateMaxOffsetValue()}_applyPlotToPrecalculatedAutoscaleInfo(e,t,s,i){const r=i.id,n=this._properties.childs().styles.childs()[r],a=(0,B.isShapesPlot)(i)||(0,B.isCharsPlot)(i);s.useMainSeriesRange=s.useMainSeriesRange||(0,B.isArrowsPlot)(i);let l=(0,B.isLinePlot)(i)||(0,B.isOhlcPlot)(i);if(a){const e=(0,o.ensureDefined)(n).childs().location.value(),t=[N.MarkLocation.Absolute,N.MarkLocation.Top,N.MarkLocation.Bottom].indexOf(e)<0;s.useMainSeriesRange=s.useMainSeriesRange||a&&t,l=l||e===N.MarkLocation.Absolute}if(!l)return s;const h={name:r,offset:this.offset(r)},c=n.childs().plottype.value();if(!this._skipHistogramBaseOnAutoScale()&&[B.LineStudyPlotStyle.Histogram,B.LineStudyPlotStyle.Columns,B.LineStudyPlotStyle.Area].indexOf(c)>=0){const i=(this._metaInfo.styles??{})?.[r]?.histogramBase;if(void 0===i)return s;const n=this.data().minMaxOnRangeCached(e,t,[h]);return(0,W.isNumber)(i)&&null!==n&&(s.baseValueMinMax=(0,M.mergeMinMax)(s.baseValueMinMax,{min:i,max:i}),s.baseValueMinMax=(0,M.mergeMinMax)(s.baseValueMinMax,n)),s}return s.fields.push(h),s}async _onSourceInputChanged(){if(!this.isStarted()){const e=this._calcSources();{const t=1===e.length&&e[0]!==this._sources[0]?1:0;this._updateParentSources(e,t,!1)}}}_buildInputs(e){(0,o.assert)(!!e,"options not set");let t={};try{t=this._prepareInputs(e)}catch(e){
qt.logWarn("Failed to prepare study inputs: "+e)}if(e.asObject){const e={};return Object.keys(t).forEach((s=>{null!=t[s]&&(e[s]=t[s])})),e}{const e=[];return Object.keys(t).forEach((s=>{null!=t[s]&&e.push(t[s])})),e}}_prepareInput(e,t){const s=this._prepareInputValue(e,t);return!e.isFake||t.fakeInputsForDisplay||t.onlyAtomValues?s:{v:s,f:!0,t:e.type}}_plotsForAlert(){return(0,g.plotsForAlert)(this.metaInfo(),this.offset.bind(this))}_calcIsActualInterval(){const e=this._isActualInterval;this._isActualInterval=(0,Rt.isActualInterval)(this._series.intervalObj(),this._properties.childs().intervalsVisibilities),e!==this._isActualInterval&&(this._onIsActualIntervalChange.fire(),this._visibleChanged(),this.processHibernate())}_visibleChanged(){this._series.invalidateBarColorerCache()}_getNonPriceParent(){const e=this._sources;for(const t of e)if(t instanceof us){const e=t.metaInfo();return e.is_price_study&&"Compare@tv-basicstudies"!==e.id?t._getNonPriceParent():t}return null}_updateInputValue(e,t){const s=this._properties.childs().inputs.childs();if(s[t.id])if("price"===t.type)s[t.id].setValue(e.price);else if("time"===t.type){const i=this._model.timeScale().indexToTimePoint(e.index);null!==i&&s[t.id].setValue(1e3*i)}}_initializeStudyInputsPaneViews(){const e=(0,_.editableStudyInputs)(this._metaInfo.inputs);if(0===e.length)return;const t={convertPriceToCoordinate:e=>{const t=this.priceScale();if(null!==t&&!t.isEmpty()){const s=this.firstValue();if(null!==s)return t.priceToCoordinate(e,s)}return null},formatPrice:e=>{const t=this.priceScale();if(null!==t&&!t.isEmpty()){const s=this.firstValue();if(null!==s)return t.formatPrice(e,s)}return""},getInputValue:e=>this._properties.childs().inputs.child(e)?.value()??null,isSelected:()=>this._model.selection().isSelected(this),isHovered:()=>this===this._model.hoveredSource()};Promise.all([s.e(62183).then(s.bind(s,566195)),s.e(62183).then(s.bind(s,384892)),s.e(62183).then(s.bind(s,373109)),s.e(62183).then(s.bind(s,745642))]).then((s=>{const[i,r,n,o]=s;this._inputsAnchorsPaneView=new i.StudyInputsAnchorsPaneView(e,this._model,t);const a=e.filter((e=>!Array.isArray(e)));this._inputsLinesPaneView=new r.StudyInputsLinesPaneView(a,this._model,t);let l=!1;e.forEach((e=>{if(Array.isArray(e)){const s="time"===e[0].type?e[0]:e[1],i="price"===e[0].type?e[0]:e[1];this._inputsTimeAxisPaneViews.push(new n.StudyInputTimeAxisPaneView(s,this._model,t.getInputValue)),this._inputsPriceAxisPaneViews.push(new o.StudyInputPriceAxisPaneView(i,t)),l=!0}else"time"===e.type?this._inputsTimeAxisPaneViews.push(new n.StudyInputTimeAxisPaneView(e,this._model,t.getInputValue)):(this._inputsPriceAxisPaneViews.push(new o.StudyInputPriceAxisPaneView(e,t)),l=!0)})),l&&this.formatterChanged().subscribe(this,this.invalidateTitleCache)}))}_updateCurrencySourceSymbolInfo(){}_initializeCurrencySource(){const e=this.metaInfo(),t="symbolInputSymbolSource"===e.symbolSource?.type&&e.symbolSource?.inputId,s=e.inputs.find((e=>e.id===t));if("string"==typeof t&&"symbol"===s?.type&&e.is_price_study){
const e=this._properties.childs().inputs.childs()[t];void 0!==e&&(e.subscribe(this,this._onCurrencyMayChange),this._currencySourceSymbolInputProperty=e)}}_recreatePaneViews(){this.hasBarColorer()&&this._model.mainSeries().invalidateBarStylesCache(),this._createViews(),this.recalculate(),this.updateAllViews((0,Dt.sourceChangeEvent)(this.id()))}_pinePatchProps(){this._deferredPinePatchProps=!1;const e=this._prepareInputs(Zt);if(!this._areStudyInputsModified(e))return;this._oldStudyInputs=e;const t=(0,S.patchPropertiesAsync)(this._properties,this._metaInfo,e,this._previousPatchMap),s=this._allSymbolsAreResolved(),i=this._propertiesPatched=new Promise((e=>{const r=()=>{i===this._propertiesPatched?e():this._propertiesPatched.then(e)};Promise.all([t,s]).then((()=>{r(),this._isDestroyed||(this._createViews(),this.recalculate(),this.updateAllViews((0,Dt.sourceChangeEvent)(this.id())),this.invalidateTitleCache())})).catch((e=>{r(),qt.logError(`ERROR: ${this._debugId()} pine inputs patching failed, reason: ${e}`)}))}))}_areStudyInputsModified(e){if(0===Object.keys(e).length)return!1;if(void 0===this._oldStudyInputs)return!0;const t=Object.keys(this._oldStudyInputs);(0,o.assert)(t.length===Object.keys(e).length,"keys quantity should be equal");for(const s of t)if((0,o.assert)(e.hasOwnProperty(s),`key '${s}' should exist in study inputs`),(0,o.ensureDefined)(this._oldStudyInputs)[s]!==e[s])return!0;return!1}_onVisibleTimeRangeInputsChanged(e){null!==e?this._updateVisibleTimeRangeInputs(e):this.isStarted()&&this._chartApi.isConnected().value()&&this.stop(!0)}_updateVisibleTimeRangeInputs(e,t=!0){const s={first_visible_bar_time:e.firstVisibleBarTime,last_visible_bar_time:e.lastVisibleBarTime,subscribeRealtime:e.subscribeRealtime},i=this.metaInfo().inputs,r=[];for(const e of i)s.hasOwnProperty(e.id)&&r.push(e.id);const n=this.properties().childs().inputs;for(const e of r)n.childs()[e].setValueSilently(s[e]);t&&r.length>0&&n.listeners().fire(n,"")}_getStudyErrorText(e){switch(e.match(/^study_not_auth:(.*)?@.*/)?.[1]){case"Script":case"StrategyScript":return"This script is invite-only. To request access, please contact its author.";case"VbPSessions":case"VbPPeriodic":case"VbPVisible":return"Volume Profile indicator available only on our upgraded plans."}return e.split(":",2)[0]}_priceScaleByProperties(){if("default"===this.properties().childs().precision.value())return null;const e=parseInt(this.properties().childs().precision.value());return isFinite(e)?Math.pow(10,e):null}_priceScaleByMetaInfo(){const e=this.metaInfo().format,t="inherit"!==e.type?e.precision:void 0,s=(0,W.isNumber)(t)?Math.pow(10,t):void 0;if("price"===e.type||"percent"===e.type)return s||100;if("volume"===e.type){if(void 0===e.precision){const e=this.series().symbolInfo();if(null!==e&&(0,W.isNumber)(e.volume_precision))return Math.pow(10,e.volume_precision)}return 1}return"inherit"===e.type||qt.logWarn("Unsupported format type: "+e.type),null}_inputSymbols(){return this.metaInfo().inputs.filter((e=>"symbol"===e.type)).map((e=>(0,
o.ensureDefined)(this._properties.childs().inputs.child(e.id)).value()))}_studySpec(e){return{id:this._metaInfo.id,child:e??this.isChildStudy(),fundamental:(0,ce.isFundamentalStudyMetaInfo)(this._metaInfo)}}_onFormatterPropsChanged(){this._recreatePriceFormattingDependencies()}_setSources(e){this.invalidateTitleCache(),this._sources=e,this._onParentSourcesChanges.fire()}}},359658:(e,t,s)=>{s.d(t,{plotShapesData:()=>r});var i=s(444372);const r={shape_arrow_down:{guiName:i.t(null,void 0,s(734247)),id:"shape_arrow_down",paneRendererClass:"PaneRendererArrowDown",pineName:"shape.arrowdown",icon:"arrow_down"},shape_arrow_up:{guiName:i.t(null,void 0,s(777231)),id:"shape_arrow_up",paneRendererClass:"PaneRendererArrowUp",pineName:"shape.arrowup",icon:"arrow_up"},shape_circle:{guiName:i.t(null,void 0,s(191944)),id:"shape_circle",paneRendererClass:"PaneRendererCircleShape",pineName:"shape.circle",icon:"circle"},shape_cross:{guiName:i.t(null,void 0,s(506969)),id:"shape_cross",paneRendererClass:"PaneRendererCrossShape",pineName:"shape.cross",icon:"cross"},shape_diamond:{guiName:i.t(null,void 0,s(415179)),id:"shape_diamond",paneRendererClass:"PaneRendererDiamond",pineName:"shape.diamond",icon:"diamond"},shape_flag:{guiName:i.t(null,void 0,s(333885)),id:"shape_flag",paneRendererClass:"PaneRendererFlagShape",pineName:"shape.flag",icon:"flag"},shape_label_down:{guiName:i.t(null,void 0,s(785924)),id:"shape_label_down",paneRendererClass:"PaneRendererLabelDown",pineName:"shape.labeldown",icon:"label_down"},shape_label_up:{guiName:i.t(null,void 0,s(649857)),id:"shape_label_up",paneRendererClass:"PaneRendererLabelUp",pineName:"shape.labelup",icon:"label_up"},shape_square:{guiName:i.t(null,void 0,s(66205)),id:"shape_square",paneRendererClass:"PaneRendererSquare",pineName:"shape.square",icon:"square"},shape_triangle_down:{guiName:i.t(null,void 0,s(676152)),id:"shape_triangle_down",paneRendererClass:"PaneRendererTriangleApexDown",pineName:"shape.triangledown",icon:"triangle_down"},shape_triangle_up:{guiName:i.t(null,void 0,s(21236)),id:"shape_triangle_up",paneRendererClass:"PaneRendererTriangleApexUp",pineName:"shape.triangleup",icon:"triangle_up"},shape_xcross:{guiName:i.t(null,void 0,s(211316)),id:"shape_xcross",paneRendererClass:"PaneRendererXCross",pineName:"shape.xcross",icon:"x_cross"}}},682170:(e,t,s)=>{var i=s(474150).isStudyStateForAlertType,r=s(748947),n=s(745397).generateTitleForGui,o=s(338619).getLogger("Alerts.Band"),a=s(975179),l=s(881025),h=s(889301).lineToolsLocalizedNames;TradingView="object"==typeof s.g?s.g.TradingView:TradingView||{};var c={create:function(e){var t,s=e||{},r=s.type;if("MainSeries"===r)t=d;else if(i(r,!0))t=p;else if("Value"===r)t=_;else{if(!/^LineTool.*/i.test(r))return o.logError("Unknown alert band type "+r),null;t=f}return new t(s)}};function u(e){this._band=e||{}}function d(){u.apply(this,arguments)}function p(){u.apply(this,arguments)}function _(){u.apply(this,arguments)}function f(){u.apply(this,arguments)}u.prototype.id=function(){return this._band.id},u.prototype.type=function(){
return this._band.type},u.prototype.title=function(){return this._band.title},u.prototype.isTVScript=function(){return this._band.isTVScript},u.prototype.scriptVersion=function(){return this._band.scriptVersion},u.prototype.hasPlots=function(){return this._band.plots&&this._band.plots.length},u.prototype.getActualSymbol=function(){return this._band.actualSymbol},u.prototype.getSymbolString=function(){return this._band.symbolString},u.prototype.getPlotTitle=function(e){return e.title?e.title:r.isOhlcOpenPlot(e)?e.ohlcTitle+" "+s.i18next(null,void 0,s(16610)):r.isOhlcHighPlot(e)?e.ohlcTitle+" "+s.i18next(null,void 0,s(778254)):r.isOhlcLowPlot(e)?e.ohlcTitle+" "+s.i18next(null,void 0,s(165318)):r.isOhlcClosePlot(e)?e.ohlcTitle+" "+s.i18next(null,void 0,s(862578)):"vol"===e.id?s.i18next(null,void 0,s(937644)):"vol_ma"===e.id?s.i18next(null,void 0,s(609373)):"open"===e.id?s.i18next(null,void 0,s(16610)):"high"===e.id?s.i18next(null,void 0,s(778254)):"low"===e.id?s.i18next(null,void 0,s(165318)):"close"===e.id?s.i18next(null,void 0,s(862578)):e.id},u.prototype.getPlots=function(e){var t=e||{};if(!this._band.plots||!this._band.plots.length)return this._band.plots;if("inputSelect"===t.format){var s=-1;return this._band.plots.map((function(e){return{value:++s,title:this.getPlotTitle(e)}}),this)}return this._band.plots},u.prototype.hasUsualPlots=function(){var e=this._band.plots;return!e||e.filter(r.isAlertConditionPlot).length<e.length},u.prototype.getInputs=function(){return{}},inherit(d,u),d.prototype.title=function(e){var t=s(268552),i=e||{},r=!!i.withInterval,o=this._band.actualSymbol;return t&&(o=t.shortName(o)),n({symbol:o,interval:r?this._band.interval:void 0,style:this._band.style,inputs:this._band.styleInputs||{},boxSize:this._band.boxSize,reversalAmount:this._band.reversalAmount,sessionDescription:i.sessionDescription})},d.prototype.getInterval=function(){return this._band.interval},d.prototype.getStyle=function(){return this._band.style},d.prototype.getStyleInputs=function(){return this._band.styleInputs},d.prototype.isRangeBasedStyle=function(){return a.isRangeBasedStyle(this._band.style)},d.prototype.isSpread=function(){return this._band.isSpread},d.prototype.sessionId=function(){return this._band.sessionId},d.prototype.sessionDescription=function(){return this._band.sessionDescription},d.prototype.getDividendsAdjustment=function(){return this._band.dividendsAdjustment},d.prototype.getBackAdjustment=function(){return this._band.backAdjustment},d.prototype.getSettlementAsClose=function(){return this._band.settlementAsClose},inherit(p,u),p.prototype.title=function(e){var t,i,r,n=e||{},o=n.withPlotTitle,a=this._band;return n.short&&a.shortTitle?t=a.shortTitle:a.title?t=a.title:(t=a.shortDescription||"Study",i=[],Object.keys(a.inputs).forEach((function(e){var t=a.inputs[e]&&a.inputs[e].id;t&&!a.inputs[e].isHidden&&void 0!==a.inputs[t]&&i.push(a.inputs[t])})),i.length&&(t+=" ("+i.join(", ")+")")),o&&(r=this.selectedPlot())&&(t+=" "+(r.title||s.i18next(null,void 0,s(370589)))),l.isRtl()&&(t=l.forceLTRStr(t)),t},
p.prototype.selectedPlot=function(){var e=this._band;return void 0===e.plotIndex?null:this.getPlots().filter((function(t){return t.value===e.plotIndex}))[0]||null},p.prototype.getInputs=function(){return this._band.inputs||{}},p.prototype.isTVLibrary=function(){return this._band.isTVLibrary||!1},p.prototype.scriptIdPart=function(){return this._band.scriptIdPart},inherit(_,u),_.prototype.title=function(e){var t=this._band.value||0;return e.formatter?e.formatter.format(parseFloat(t)):parseFloat(t).toString()},inherit(f,u),f.prototype.title=function(){return h[this._band.type]||this.title()},e.exports.alertBandFactory=c},545437:(e,t,s)=>{s.d(t,{showTooManyStudiesNotice:()=>n});var i=s(444372),r=s(779923);function n(e){(0,r.showWarning)({title:i.t(null,void 0,s(966719)),text:i.t(null,{replace:{number:`${e}`}},s(586146))})}}}]);